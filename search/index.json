[{"content":"æ­£æ–‡æµ‹è¯• è€Œè¿™äº›å¹¶ä¸æ˜¯å®Œå…¨é‡è¦ï¼Œæ›´åŠ é‡è¦çš„é—®é¢˜æ˜¯ï¼Œ å¸¦ç€è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬æ¥å®¡è§†ä¸€ä¸‹å­¦ç”Ÿä¼šé€€ä¼šã€‚ æ—¢ç„¶å¦‚ä½•ï¼Œ å¯¹æˆ‘ä¸ªäººè€Œè¨€ï¼Œå­¦ç”Ÿä¼šé€€ä¼šä¸ä»…ä»…æ˜¯ä¸€ä¸ªé‡å¤§çš„äº‹ä»¶ï¼Œè¿˜å¯èƒ½ä¼šæ”¹å˜æˆ‘çš„äººç”Ÿã€‚ æˆ‘ä»¬ä¸å¾—ä¸é¢å¯¹ä¸€ä¸ªéå¸¸å°´å°¬çš„äº‹å®ï¼Œé‚£å°±æ˜¯ï¼Œ å¯æ˜¯ï¼Œå³ä½¿æ˜¯è¿™æ ·ï¼Œå­¦ç”Ÿä¼šé€€ä¼šçš„å‡ºç°ä»ç„¶ä»£è¡¨äº†ä¸€å®šçš„æ„ä¹‰ã€‚ å­¦ç”Ÿä¼šé€€ä¼šï¼Œå‘ç”Ÿäº†ä¼šå¦‚ä½•ï¼Œä¸å‘ç”Ÿåˆä¼šå¦‚ä½•ã€‚ ç»è¿‡ä¸Šè¿°è®¨è®ºï¼Œ ç”Ÿæ´»ä¸­ï¼Œè‹¥å­¦ç”Ÿä¼šé€€ä¼šå‡ºç°äº†ï¼Œæˆ‘ä»¬å°±ä¸å¾—ä¸è€ƒè™‘å®ƒå‡ºç°äº†çš„äº‹å®ã€‚ å­¦ç”Ÿä¼šé€€ä¼šï¼Œåˆ°åº•åº”è¯¥å¦‚ä½•å®ç°ã€‚ è¿™æ ·çœ‹æ¥ï¼Œ åœ¨è¿™ç§å›°éš¾çš„æŠ‰æ‹©ä¸‹ï¼Œæœ¬äººæ€æ¥æƒ³å»ï¼Œå¯é£Ÿéš¾å®‰ã€‚ å¯¹æˆ‘ä¸ªäººè€Œè¨€ï¼Œå­¦ç”Ÿä¼šé€€ä¼šä¸ä»…ä»…æ˜¯ä¸€ä¸ªé‡å¤§çš„äº‹ä»¶ï¼Œè¿˜å¯èƒ½ä¼šæ”¹å˜æˆ‘çš„äººç”Ÿã€‚ å°±æˆ‘ä¸ªäººæ¥è¯´ï¼Œå­¦ç”Ÿä¼šé€€ä¼šå¯¹æˆ‘çš„æ„ä¹‰ï¼Œä¸èƒ½ä¸è¯´éå¸¸é‡å¤§ã€‚ èå£«æ¯”äºšæ›¾ç»æåˆ°è¿‡ï¼Œäººçš„ä¸€ç”Ÿæ˜¯çŸ­çš„ï¼Œä½†å¦‚æœå‘åŠ£åœ°è¿‡è¿™ä¸€ç”Ÿï¼Œå°±å¤ªé•¿äº†ã€‚è¿™ä¼¼ä¹è§£ç­”äº†æˆ‘çš„ç–‘æƒ‘ã€‚ è«æ‰ç‰¹è¯´è¿‡ä¸€å¥å¯Œæœ‰å“²ç†çš„è¯ï¼Œè°å’Œæˆ‘ä¸€æ ·ç”¨åŠŸï¼Œè°å°±ä¼šå’Œæˆ‘ä¸€æ ·æˆåŠŸã€‚è¿™å¯å‘äº†æˆ‘ï¼Œ å¯¹æˆ‘ä¸ªäººè€Œè¨€ï¼Œå­¦ç”Ÿä¼šé€€ä¼šä¸ä»…ä»…æ˜¯ä¸€ä¸ªé‡å¤§çš„äº‹ä»¶ï¼Œè¿˜å¯èƒ½ä¼šæ”¹å˜æˆ‘çš„äººç”Ÿã€‚ å­¦ç”Ÿä¼šé€€ä¼šï¼Œåˆ°åº•åº”è¯¥å¦‚ä½•å®ç°ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œ ä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼Œ è¿™ç§äº‹å®å¯¹æœ¬äººæ¥è¯´æ„ä¹‰é‡å¤§ï¼Œç›¸ä¿¡å¯¹è¿™ä¸ªä¸–ç•Œä¹Ÿæ˜¯æœ‰ä¸€å®šæ„ä¹‰çš„ã€‚ åœ¨è¿™ç§å›°éš¾çš„æŠ‰æ‹©ä¸‹ï¼Œæœ¬äººæ€æ¥æƒ³å»ï¼Œå¯é£Ÿéš¾å®‰ã€‚ äº†è§£æ¸…æ¥šå­¦ç”Ÿä¼šé€€ä¼šåˆ°åº•æ˜¯ä¸€ç§æ€ä¹ˆæ ·çš„å­˜åœ¨ï¼Œæ˜¯è§£å†³ä¸€åˆ‡é—®é¢˜çš„å…³é”®ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œ ç”Ÿæ´»ä¸­ï¼Œè‹¥å­¦ç”Ÿä¼šé€€ä¼šå‡ºç°äº†ï¼Œæˆ‘ä»¬å°±ä¸å¾—ä¸è€ƒè™‘å®ƒå‡ºç°äº†çš„äº‹å®ã€‚ é—®é¢˜çš„å…³é”®ç©¶ç«Ÿä¸ºä½•ï¼Ÿ è€Œè¿™äº›å¹¶ä¸æ˜¯å®Œå…¨é‡è¦ï¼Œæ›´åŠ é‡è¦çš„é—®é¢˜æ˜¯ã€‚\nå¥¥æ–¯ç‰¹æ´›å¤«æ–¯åŸºæ›¾ç»è¯´è¿‡ï¼Œå…±åŒçš„äº‹ä¸šï¼Œå…±åŒçš„æ–—äº‰ï¼Œå¯ä»¥ä½¿äººä»¬äº§ç”Ÿå¿å—ä¸€åˆ‡çš„åŠ›é‡ã€‚ã€€å¸¦ç€è¿™å¥è¯ï¼Œæˆ‘ä»¬è¿˜è¦æ›´åŠ æ…é‡çš„å®¡è§†è¿™ä¸ªé—®é¢˜ï¼š ä¸€èˆ¬æ¥è®²ï¼Œæˆ‘ä»¬éƒ½å¿…é¡»åŠ¡å¿…æ…é‡çš„è€ƒè™‘è€ƒè™‘ã€‚ æ—¢ç„¶å¦‚æ­¤ï¼Œ è¿™ç§äº‹å®å¯¹æœ¬äººæ¥è¯´æ„ä¹‰é‡å¤§ï¼Œç›¸ä¿¡å¯¹è¿™ä¸ªä¸–ç•Œä¹Ÿæ˜¯æœ‰ä¸€å®šæ„ä¹‰çš„ã€‚ å¸¦ç€è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬æ¥å®¡è§†ä¸€ä¸‹å­¦ç”Ÿä¼šé€€ä¼šã€‚ æˆ‘è®¤ä¸ºï¼Œ æˆ‘è®¤ä¸ºï¼Œ åœ¨è¿™ç§å›°éš¾çš„æŠ‰æ‹©ä¸‹ï¼Œæœ¬äººæ€æ¥æƒ³å»ï¼Œå¯é£Ÿéš¾å®‰ã€‚ é—®é¢˜çš„å…³é”®ç©¶ç«Ÿä¸ºä½•ï¼Ÿ æ¯ä¸ªäººéƒ½ä¸å¾—ä¸é¢å¯¹è¿™äº›é—®é¢˜ã€‚ åœ¨é¢å¯¹è¿™ç§é—®é¢˜æ—¶ï¼Œ è¦æƒ³æ¸…æ¥šï¼Œå­¦ç”Ÿä¼šé€€ä¼šï¼Œåˆ°åº•æ˜¯ä¸€ç§æ€ä¹ˆæ ·çš„å­˜åœ¨ã€‚ æˆ‘è®¤ä¸ºï¼Œ æ—¢ç„¶å¦‚æ­¤ï¼Œ æ¯ä¸ªäººéƒ½ä¸å¾—ä¸é¢å¯¹è¿™äº›é—®é¢˜ã€‚ åœ¨é¢å¯¹è¿™ç§é—®é¢˜æ—¶ï¼Œ é‚£ä¹ˆï¼Œ æˆ‘è®¤ä¸ºï¼Œ å­¦ç”Ÿä¼šé€€ä¼šå› ä½•è€Œå‘ç”Ÿã€‚\nå¼•ç”¨ æ€å¿µæ˜¯æœ€æš–çš„å¿§ä¼¤åƒä¸€åŒç¿…è†€\nè®©æˆ‘åœä¸äº†é£ä¸è¿œåœ¨è¿‡å¾€æ¸¸è¡\nä¸å‘Šè€Œåˆ«çš„ä½  å°±ç®—ä¸ºäº†æˆ‘ç€æƒ³\nè¿™ä¹ˆæ²‰ç—›çš„å‘µæŠ¤ æˆ‘æ€ä¹ˆèƒ½ç¿±ç¿”\næœ€æš–çš„æ†‚å‚· - ç”°é¦¥ç”„\nå›¾ç‰‡ 1 2 3 ![Photo by Florian Klauer on Unsplash](florian-klauer-nptLmg6jqDo-unsplash.jpg) ![Photo by Luca Bravo on Unsplash](luca-bravo-alS7ewQ41M8-unsplash.jpg) ![Photo by Helena Hertz on Unsplash](helena-hertz-wWZzXlDpMog-unsplash.jpg) ![Photo by Hudai Gayiran on Unsplash](hudai-gayiran-3Od_VKcDEAA-unsplash.jpg) ç›¸å†Œè¯­æ³•æ¥è‡ª Typlog\n","date":"2020-09-09T00:00:00Z","image":"https://pypotato.github.io/p/test-chinese/helena-hertz-wWZzXlDpMog-unsplash_hu45a5e3ad5e058da6a00650ed8fd40bea_15530_120x120_fill_q75_box_smart1.jpg","permalink":"https://pypotato.github.io/p/test-chinese/","title":"Chinese Test"},{"content":"ã€ŠKubernetes æºç å‰–æã€‹ç¬”è®° Kubernetes ç‰ˆæœ¬ï¼š1.14\nç¬¬ 5 ç« ï¼šclient-go ç¼–ç¨‹å¼äº¤äº’ Client å®¢æˆ·ç«¯å¯¹è±¡ client-go æ”¯æŒ 4 ç§ Client å®¢æˆ·ç«¯å¯¹è±¡æ¥ä¸ Kubernetes API Server äº¤äº’ï¼š\nå…¶ä¸­ RESTClient æ˜¯æœ€åŸºç¡€çš„å®¢æˆ·ç«¯ã€‚RESTClient å¯¹ HTTP Request è¿›è¡Œäº†å°è£…ï¼Œå®ç°äº† RESTful é£æ ¼çš„ APIã€‚å…¶ä»–ä¸‰ç§å®¢æˆ·ç«¯éƒ½æ˜¯åŸºäº RESTClient å®ç°çš„ã€‚\nClientsetï¼š æ˜¯å¤šä¸ª Client å®¢æˆ·ç«¯çš„é›†åˆï¼Œåªèƒ½å¤„ç† K8s å†…ç½®èµ„æºã€‚ dynamicClientï¼š åŠ¨æ€å®¢æˆ·ç«¯ï¼Œå¯ä»¥æ“ä½œä»»æ„ k8s èµ„æºï¼ŒåŒ…æ‹¬CRDèµ„æºã€‚ kubeconfig é…ç½®ç®¡ç† kubeconfig ç”¨äºç®¡ç†è®¿é—® kube-apiserver çš„é…ç½®ä¿¡æ¯ï¼ŒåŒæ—¶å®ƒè¿˜æ”¯æŒè®¿é—®å¤š kube-apiserverçš„é…ç½®ç®¡ç†ï¼ŒKubernetes çš„å…¶ä»–ç»„ä»¶éƒ½ä½¿ç”¨ kubeconfig é…ç½®ä¿¡æ¯æ¥è¿æ¥ kube-apiserver ç»„ä»¶ã€‚\nkubeconfig ç§å­˜å‚¨äº†é›†ç¾¤ã€ç”¨æˆ·ã€å‘½åç©ºé—´å’Œèº«ä»½éªŒè¯ç­‰ä¿¡æ¯ï¼Œä»–é€šå¸¸åŒ…å« 3 éƒ¨åˆ†ï¼š\nclustersï¼šå®šä¹‰é›†ç¾¤ä¿¡æ¯ï¼Œå¦‚ kube-apiserver çš„æœåŠ¡åœ°å€åŠé›†ç¾¤çš„è¯ä¹¦ä¿¡æ¯ç­‰ã€‚ usersï¼šå®šä¹‰äº†é›†ç¾¤ç”¨æˆ·èº«ä»½éªŒè¯çš„å®¢æˆ·ç«¯å‡­æ®ã€‚ contextsï¼šå®šä¹‰é›†ç¾¤ç”¨æˆ·ä¿¡æ¯å’Œå‘½åç©ºé—´ç­‰ï¼Œç”¨äºå°†è¯·æ±‚å‘é€åˆ°æŒ‡å®šçš„é›†ç¾¤ã€‚ client-go ä¼šè¯»å– kubeconfig é…ç½®ä¿¡æ¯ï¼Œå¹¶ç”Ÿæˆ config å¯¹è±¡ï¼Œç”¨äºä¸ kube-apiserver é€šä¿¡ã€‚\n1 2 3 4 5 6 7 func main() { config, err := clientcmd.BuildConfigFromFlag(\u0026#34;\u0026#34;, clientcmd.RecommendedHomeFile) if err != nil { panic(err) } ... } RESTClient å®¢æˆ·ç«¯ 1 2 3 4 5 6 7 8 9 10 11 12 func main() { ... restClient, err := rest.RESTClientFor(config) result := \u0026amp;corev1.PodList{} err = restClient.Get(). Namespace(\u0026#34;default\u0026#34;). Resource(\u0026#34;pods\u0026#34;). VersionedParams(\u0026amp;metav1.ListOptions{limit:500},scheme.ParameterCodec). Do(). Into(result) } ä¸Šé¢çš„ä»£ç ç”¨ config å¯¹è±¡å®ä¾‹åŒ–äº† RESTClient å¯¹è±¡ï¼Œè¿›è€Œæ„å»º HTTP è¯·æ±‚å‚æ•°ã€‚RESTClient å‘é€è¯·æ±‚çš„è¿‡ç¨‹å¯¹ Go è¯­è¨€æ ‡å‡†åº“ net/http è¿›è¡Œäº†å°è£…ï¼Œç”± Do å‡½æ•°å®ç°ï¼š\n1 2 3 4 5 6 7 8 // file: staging/src/k8s.io/client-go/rest/request.go func (r *Request) Do(ctx context.Context) Result { var result Result err := r.request(ctx, func(req *http.Request, resp *http.Response) { result = r.transformResponse(resp, req) }) ... } ClientSet å®¢æˆ·ç«¯ RESTClient ä½œä¸ºä¸€ç§æœ€åŸºç¡€çš„å®¢æˆ·ç«¯ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™éœ€è¦æŒ‡å®š Resource å’Œ Version ç­‰ä¿¡æ¯ï¼Œç¼–ç æ—¶éœ€è¦æå‰çŸ¥é“ Resource æ‰€åœ¨çš„ Group å’Œå¯¹åº”çš„ Version ä¿¡æ¯ï¼ˆå…·ä½“å®è·µå¯ä»¥åœ¨ b ç«™è§†é¢‘ ä¸­çœ‹åˆ°ï¼‰ã€‚\nä¸ä¹‹ç›¸æ¯”ï¼ŒClientSet ä½¿ç”¨èµ·æ¥æ›´åŠ ä¾¿æ·ï¼Œå®ƒåœ¨ RESTClient çš„åŸºç¡€ä¸Šå°è£…äº†å¯¹ Resource å’Œ Version çš„ç®¡ç†æ–¹æ³•ã€‚\næ¯ä¸€ä¸ª Resource å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œè€Œ ClientSet æ˜¯å¤šä¸ªå®¢æˆ·ç«¯çš„é›†åˆï¼Œæ¯ä¸€ä¸ª Resource å’Œ Version éƒ½ä»¥å‡½æ•°çš„æ–¹å¼æš´éœ²ç»™å¼€å‘è€…ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func main() { ... clientSet, err := kubernetes.NewForConfig(config) if err != nil { panic(err) } // æ¯ä¸€ä¸ª Resource å’Œ Version éƒ½ä»¥å‡½æ•°çš„æ–¹å¼æš´éœ²ç»™å¼€å‘è€… podClient := clientSet.CoreV1().Pods(apiv1.NamespaceDefault) list, err := podClient.List(metav1.ListOptions{limit:500}) if err != nil { panic(err) } } å¯¹ Pod èµ„æºå¯¹è±¡æ‰§è¡Œ List æ“ä½œå®é™…ä¸Šæ˜¯å¯¹ RESTClient è¿›è¡Œäº†å°è£…ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 // file: staging/src/k8s.io/client-go/kubernetes/typed/core/v1/pod.go func (c *pods) List(ctx context.Context, opts metav1.ListOptions) (result *v1.PodList, err error) { ... result = \u0026amp;v1.PodList{} err = c.client.Get(). Namespace(c.ns). Resource(\u0026#34;pods\u0026#34;). VersionedParams(\u0026amp;opts, scheme.ParameterCodec). Timeout(timeout). Do(ctx). Into(result) return } DynamicClient å®¢æˆ·ç«¯ DynamicClient å’Œ ClientSet ç±»ä¼¼ï¼Œä¹Ÿæ˜¯å¯¹ RESTClient çš„å°è£…ï¼Œä¸è¿‡å®ƒä¸ä»…å¯ä»¥å¯¹ Kubernetes å†…ç½®èµ„æºæ“ä½œï¼Œè¿˜èƒ½å¯¹ CRD æ“ä½œã€‚\nè¿™æ˜¯å› ä¸ºï¼ŒClientSet éœ€è¦é¢„å…ˆå®ç°æ¯ç§ Resource å’Œ Version çš„æ“ä½œï¼Œå…¶å†…éƒ¨çš„æ•°æ®éƒ½æ˜¯ç»“æ„åŒ–æ•°æ®ã€‚è€Œ DynamicClient å†…éƒ¨å®ç°äº† Unstructuredï¼Œè¿™ä½¿å®ƒèƒ½å¤Ÿå¤„ç†ç”¨æˆ·è‡ªå®šä¹‰èµ„æºï¼ˆæ— æ³•æå‰é¢„çŸ¥æ•°æ®ç»“æ„ï¼‰ã€‚\nDynamicClient ä¸æ˜¯ç±»å‹å®‰å…¨çš„ï¼Œå› æ­¤åœ¨è®¿é—® CRD è‡ªå®šä¹‰èµ„æºæ—¶éœ€è¦ç‰¹åˆ«æ³¨æ„ã€‚ä¾‹å¦‚ï¼Œåœ¨æ“ä½œæŒ‡é’ˆä¸å½“çš„æƒ…å†µä¸‹ä¼šå¯¼è‡´ç¨‹åºå´©æºƒã€‚\nClientSet ç”¨äºæ“ä½œ Kubernetes ä¸­çš„å†…å»ºèµ„æºã€‚è¿™äº›å†…å»ºèµ„æºéƒ½æœ‰ä¸¥æ ¼çš„ API è§„èŒƒï¼ŒåŒ…æ‹¬æ¯ä¸ªèµ„æºçš„å­—æ®µç±»å‹å’Œç»“æ„ï¼Œåœ¨ä½¿ç”¨ clientset æ—¶ï¼Œå¼€å‘äººå‘˜åªèƒ½æ“ä½œè¿™äº›å·²çŸ¥çš„èµ„æºï¼Œå¹¶ä¸”è¿™äº›èµ„æºçš„ç»“æ„åœ¨ç¼–è¯‘æ—¶å°±å·²ç»ç¡®å®šäº†ã€‚å› æ­¤ä¸å¤ªå¯èƒ½å‡ºç°ç±»å‹ä¸åŒ¹é…çš„é—®é¢˜ã€‚è€Œå¯¹äºå¯ä»¥æ“ä½œè‡ªå®šä¹‰èµ„æºçš„ DynamicClientï¼Œåˆ™ä¸ä¸€å®šï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 func main() { // å»ºç«‹åˆ° Kubernetes é›†ç¾¤çš„è¿æ¥ config, err := rest.InClusterConfig() if err != nil { // å¤„ç†é”™è¯¯ fmt.Fprintf(os.Stderr, \u0026#34;Failed to get in-cluster config: %v\\n\u0026#34;, err) return } // åˆ›å»ºä¸€ä¸ª DynamicClient dynamicClient, err := dynamic.NewForConfig(config) if err != nil { // å¤„ç†é”™è¯¯ fmt.Fprintf(os.Stderr, \u0026#34;Failed to create DynamicClient: %v\\n\u0026#34;, err) return } // å®šä¹‰è‡ªå®šä¹‰èµ„æºå¯¹è±¡çš„ GVKï¼ˆGroup-Version-Kindï¼‰ gvk := schema.GroupVersionKind{ Group: \u0026#34;example.com\u0026#34;, Version: \u0026#34;v1\u0026#34;, Kind: \u0026#34;CustomResource\u0026#34;, } // åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰èµ„æºå¯¹è±¡ resource := schema.GroupVersionResource{ Group: \u0026#34;example.com\u0026#34;, Version: \u0026#34;v1\u0026#34;, Resource: \u0026#34;customresources\u0026#34;, } // åˆ›å»ºä¸€ä¸ªé”™è¯¯çš„ CustomResource å®ä¾‹ï¼Œæ²¡æœ‰è®¾ç½® spec å­—æ®µ obj := map[string]interface{}{ \u0026#34;apiVersion\u0026#34;: \u0026#34;example.com/v1\u0026#34;, \u0026#34;kind\u0026#34;: \u0026#34;CustomResource\u0026#34;, \u0026#34;metadata\u0026#34;: map[string]interface{}{ \u0026#34;name\u0026#34;: \u0026#34;example-cr\u0026#34;, }, \u0026#34;status\u0026#34;: map[string]interface{}{ \u0026#34;field\u0026#34;: \u0026#34;value\u0026#34;, }, } // åœ¨å¯¹è±¡ä¸Šè°ƒç”¨ Create æ–¹æ³•ï¼Œè¿™å¯èƒ½å¯¼è‡´ç±»å‹ä¸å®‰å…¨è€Œå´©æºƒ _, err = dynamicClient.Resource(resource).Namespace(\u0026#34;default\u0026#34;).Create(context.TODO(), obj, metav1.CreateOptions{}) if err != nil { // å¤„ç†é”™è¯¯ fmt.Fprintf(os.Stderr, \u0026#34;Failed to create custom resource: %v\\n\u0026#34;, err) return } } DynamicClient çš„å¤„ç†è¿‡ç¨‹å°† Resourceï¼ˆå¦‚ PodListï¼‰è½¬æ¢æˆ Unstructured ç»“æ„ç±»å‹ï¼Œå¤„ç†å®Œæˆåï¼Œå†å°† unstructured è½¬æ¢æˆ PodListã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func main() { ... dynamicClient, err := dynamic.NewForConfig(config) if err != nil { panic(err) } gvr := schema.GroupVersionResource{Version: \u0026#34;v1\u0026#34;, Resource: \u0026#34;pods\u0026#34;} unstructObj, err := dynamicClient.Resource(gvr). // è®¾ç½®èµ„æºç»„ã€èµ„æºç‰ˆæœ¬ã€èµ„æºåç§° Namespace(apiv1.NamespaceDefault). List(metav1.ListOptions{limit: 500}) // å¾—åˆ°çš„ Pod åˆ—è¡¨ä¸º unstructured.UnstructuredList æŒ‡é’ˆç±»å‹ if err != nil { panic(err) } podList := \u0026amp;corev1.PodList{} err = runtime.DefaultUnstructuredConvert.FromUnstructured(unstructObj.UnstructuredContent(), podList) if err != nil { panic(err) } } DiscoveryClient å®¢æˆ·ç«¯ DiscoveryClient æ˜¯å‘ç°å®¢æˆ·ç«¯ï¼Œå®ƒä¸»è¦ç”¨äºå‘ç° Kubernetes API Server æ‰€æ”¯æŒçš„èµ„æºç»„ã€èµ„æºç‰ˆæœ¬ã€èµ„æºä¿¡æ¯ã€‚Kubernetes API Server æ”¯æŒå¾ˆå¤šèµ„æºç»„ã€èµ„æºç‰ˆæœ¬ã€èµ„æºä¿¡æ¯ï¼Œå¼€å‘è€…åœ¨å¼€å‘è¿‡ç¨‹ä¸­å¾ˆéš¾è®°ä½æ‰€æœ‰ä¿¡æ¯ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡ DiscoveryClient æŸ¥çœ‹æ‰€æ”¯æŒçš„èµ„æºç»„ã€èµ„æºç‰ˆæœ¬ã€èµ„æºä¿¡æ¯ã€‚\nDiscoveryClient é™¤äº†å¯ä»¥å‘ç° Kubernetes API Server æ‰€æ”¯æŒçš„èµ„æºç»„ã€èµ„æºç‰ˆæœ¬ã€èµ„æºä¿¡æ¯ï¼Œè¿˜å¯ä»¥å°†è¿™äº›ä¿¡æ¯å­˜å‚¨åˆ°æœ¬åœ°ï¼Œç”¨äºæœ¬åœ°ç¼“å­˜ï¼ˆCacheï¼‰ï¼Œä»¥å‡è½»å¯¹ Kubernetes API Server è®¿é—®çš„å‹åŠ›ã€‚\nInformer æœºåˆ¶ Kubernetes å„ä¸ªç»„ä»¶éƒ½æ˜¯é€šè¿‡ REST APIè·ŸAPI Server äº¤äº’é€šä¿¡çš„ï¼Œè€Œå¦‚æœæ¯æ¬¡æ¯ä¸€ä¸ªç»„ä»¶éƒ½ç›´æ¥è·Ÿ API Server äº¤äº’å»è¯»å–/å†™å…¥åˆ°åç«¯çš„ etcd çš„è¯ï¼Œä¼šå¯¹ API Server ä»¥åŠ etcd é€ æˆéå¸¸å¤§çš„è´Ÿæ‹…ã€‚è€Œ Informer æœºåˆ¶æ˜¯ä¸ºäº†ä¿è¯å„ä¸ªç»„ä»¶ä¹‹é—´é€šä¿¡çš„å®æ—¶æ€§ã€å¯é æ€§ï¼Œå¹¶ä¸”å‡ç¼“å¯¹ API Serverå’Œetcd çš„è´Ÿæ‹…ã€‚\nInformer æœºåˆ¶æ¶æ„è®¾è®¡ æ¯ä¸€ä¸ª Kubernetes èµ„æºä¸Šéƒ½å®ç°äº† Informer æœºåˆ¶ã€‚æ¯ä¸€ä¸ª Informer ä¸Šéƒ½ä¼šå®ç° Informer å’Œ Lister æ–¹æ³•ï¼Œå®šä¹‰ä¸åŒèµ„æºçš„ Informer å¯ä»¥ç›‘æ§ä¸åŒèµ„æºçš„èµ„æºäº‹ä»¶ï¼š\n1 2 podInformer := sharedInformer.Core().V1().Pods().Informer() nodeInformer := sharedInformer.Node().V1beta1().RuntimeClasses().Informer() Informer ä¹Ÿç§°ä½œ Shared Informerï¼Œå®ƒæ˜¯å¯ä»¥å…±äº«ä½¿ç”¨çš„ã€‚å¦‚æœåŒä¸€èµ„æºçš„ informer è¢«å¤šæ¬¡å®ä¾‹åŒ–ï¼Œä¸”æ¯ä¸ª Informer éƒ½è¯»ç‹¬ç«‹ä½¿ç”¨ä¸€ä¸ª Reflectorï¼Œé‚£ä¹ˆä¼šè¿è¡Œè¿‡å¤šç›¸åŒçš„ ListAndWatchï¼Œå¯¼è‡´ API Server è´Ÿè½½è¿‡é‡ã€‚\nShared Informer å¯ä»¥ä½¿åŒä¸€ç±»èµ„æº Informer å…±äº«ä¸€ä¸ª Reflectorï¼Œè¿™æ ·å¯ä»¥èŠ‚çº¦å¾ˆå¤šèµ„æºã€‚é€šè¿‡ map æ•°æ®ç»“æ„å®ç°å…±äº«çš„ Informer æœºåˆ¶ã€‚\n1 2 3 4 type sharedInformerFactory struct { ... informers map[reflect.Type] cache.SharedIndexInformer } InformerFor å‡½æ•°å¯ä»¥æ·»åŠ ä¸åŒèµ„æºçš„ Informerï¼Œå¦‚æœå·²ç»å­˜åœ¨åŒç±»å‹çš„èµ„æº Informerï¼Œåˆ™è¿”å›å½“å‰ Informerã€‚\nReflector Reflector è´Ÿè´£ä¸ apiserver å»ºç«‹è¿æ¥ï¼Œä½¿ç”¨ ListAndWatch çš„æ–¹æ³•è·å–èµ„æºå¯¹è±¡çš„å¢é‡æ›´æ–°ã€‚\nReflector æºç å®ç°ä¸­æœ€ä¸»è¦çš„æ˜¯ ListerAndWatch å‡½æ•°ï¼Œå®ƒå¯ä»¥åˆ†æˆä¸¤éƒ¨åˆ†ï¼šè·å–èµ„æºåˆ—è¡¨æ•°æ®å’Œç›‘æ§èµ„æºå¯¹è±¡ã€‚\n1. è·å–èµ„æºåˆ—è¡¨æ•°æ®\nList æµç¨‹ï¼š\né¦–æ¬¡è¿æ¥æ—¶ä¼šå…ˆä» apiserver ä¸­ list è¯¥èµ„æºçš„æ‰€æœ‰å®ä¾‹ï¼Œlist ä¼šæ‹¿åˆ°è¯¥å¯¹è±¡æœ€æ–°çš„ resourceVersionï¼Œç„¶åä½¿ç”¨ watch æ–¹æ³•ç›‘å¬è¯¥ resourceVersion ä¹‹åçš„æ‰€æœ‰å˜åŒ– 2. ç›‘æ§èµ„æºå¯¹è±¡\nè‹¥ç›‘å¬ä¸­é€”å‡ºç°å¼‚å¸¸ï¼ŒReflector åœ¨é‡è¿æ—¶ä¼šæºå¸¦ä¸Šä¸ªç‰ˆæœ¬çš„ rsourceVersionï¼Œå¹¶ä»è¯¥ resourceVersion å¢é‡æ›´æ–°ï¼Œé¿å…å†æ¬¡å…¨é‡ Listã€‚ ä¸€æ—¦è¯¥å¯¹è±¡çš„å®ä¾‹æœ‰ Addã€Deleteã€Update åŠ¨ä½œï¼ŒReflector éƒ½ä¼šæ”¶åˆ° â€œäº‹ä»¶é€šçŸ¥â€ï¼Œè¿™æ—¶ï¼Œè¯¥äº‹ä»¶ä¸å¯¹åº”çš„ API å¯¹è±¡è¿™ä¸ªç»„åˆï¼Œè¢«ç§°ä¸ºå¢é‡ï¼ˆDeltaï¼‰ï¼Œå®ƒä¼šè¢«æ”¾è¿› DeltaFIFO ä¸­ã€‚ DeltaFIFO DeltaFIFOè´Ÿè´£ç®¡ç†èµ„æºå¯¹è±¡çš„å¢é‡å˜åŒ–é€šçŸ¥å’Œæä¾›å¢é‡åŒæ­¥çš„åŠŸèƒ½ã€‚\nDeltaFIFO å¯ä»¥åˆ†å¼€ç†è§£ï¼š\nFIFO æ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ã€‚ Delta æ˜¯ä¸€ä¸ªèµ„æºå¯¹è±¡å­˜å‚¨ï¼Œå¯ä»¥ä¿å­˜èµ„æºå¯¹è±¡çš„æ“ä½œç±»å‹ã€‚ 1 2 3 4 5 6 7 type DeltaFIFO struct { ... items map[string] Deltas queue []string // å­˜å‚¨èµ„æºå¯¹è±¡çš„ keyï¼Œé€šè¿‡ `KeyOf` å‡½æ•°è®¡ç®—å¾—åˆ° ... } type Deltas []Delta DeltaFIFO ä¸å…¶ä»–é˜Ÿåˆ—æœ€å¤§çš„ä¸åŒä¹‹å¤„æ˜¯ï¼Œå®ƒä¼šä¿ç•™æ‰€æœ‰å…³äºèµ„æºå¯¹è±¡ï¼ˆobjï¼‰çš„æ“ä½œç±»å‹ï¼Œé˜Ÿåˆ—ä¸­ä¼šå­˜åœ¨æ‹¥æœ‰ä¸åŒæ“ä½œç±»å‹çš„åŒä¸€ä¸ªèµ„æºå¯¹è±¡ï¼Œæ¶ˆè´¹è€…åœ¨å¤„ç†è¯¥èµ„æºå¯¹è±¡æ—¶èƒ½å¤Ÿäº†è§£è¯¥èµ„æºå¯¹è±¡æ‰€å‘ç”Ÿçš„äº‹æƒ…ã€‚\nDeltaFIFO æœ¬è´¨ä¸Šæ˜¯ä¸ªå…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—ï¼Œæœ‰ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œç”Ÿäº§è€…æ˜¯ Reflector è°ƒç”¨çš„ Add æ–¹æ³•ï¼Œæ¶ˆè´¹è€…æ˜¯ Controller è°ƒç”¨çš„ Pop æ–¹æ³•ã€‚\n1. ç”Ÿäº§è€…æ–¹æ³•\nDeltaFIFO é˜Ÿåˆ—ä¸­çš„èµ„æºå¯¹è±¡åœ¨ Added äº‹ä»¶ã€Updated äº‹ä»¶ã€Delete äº‹ä»¶ä¸­éƒ½è°ƒç”¨äº† queueActionLocked å‡½æ•°ï¼š\né¦–å…ˆé€šè¿‡ KeyOf å‡½æ•°è®¡ç®—å‡ºèµ„æºå¯¹è±¡çš„ Keyã€‚ å°† actionType å’Œèµ„æºå¯¹è±¡æ„é€ æˆ Deltaï¼Œæ·»åŠ åˆ° items ä¸­ï¼Œå¹¶å»é‡ã€‚ æ›´æ–°æ„é€ åçš„ Delta å¹¶é€šè¿‡ cond.Broadcast é€šçŸ¥æ‰€æœ‰æ¶ˆè´¹è€…è§£é™¤é˜»å¡ã€‚ 2. æ¶ˆè´¹è€…æ–¹æ³•\nPop æ–¹æ³•ä½œä¸ºæ¶ˆè´¹è€…æ–¹æ³•ä½¿ç”¨ï¼Œå®ƒçš„å…¥å‚ process æ˜¯ç”¨äºæ¥æ”¶å¹¶å¤„ç†å¯¹è±¡çš„å›è°ƒæ–¹æ³•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 func (f *DeltaFIFO) Pop(process PopProcessFunc) (interface{}, error) { f.lock.Lock() defer f.lock.Unlock() for { for len(f.queue) == 0 { //é˜»å¡ ç›´åˆ°è°ƒç”¨äº†f.cond.Broadcast() f.cond.Wait() } //å–å‡ºç¬¬ä¸€ä¸ªå…ƒç´  id := f.queue[0] f.queue = f.queue[1:] ... item, ok := f.items[id] ... delete(f.items, id) //è¿™ä¸ªprocesså¯ä»¥åœ¨controller.goä¸­çš„processLoop()æ‰¾åˆ° //åˆå§‹åŒ–æ˜¯åœ¨shared_informer.goçš„Run //æœ€ç»ˆæ‰§è¡Œåˆ°shared_informer.goçš„HandleDeltasæ–¹æ³• err := process(item) //å¦‚æœå¤„ç†å‡ºé”™äº†é‡æ–°æ”¾å›é˜Ÿåˆ—ä¸­ if e, ok := err.(ErrRequeue); ok { f.addIfNotPresent(id, item) err = e.Err } ... } } å½“é˜Ÿåˆ—ä¸­æ²¡æœ‰æ•°æ®æ—¶ï¼Œé€šè¿‡ f.cond.wait é˜»å¡ç­‰å¾…æ•°æ®ï¼Œç›´åˆ°æ”¶åˆ° cond.Broadcast æ‰è§£é™¤é˜»å¡ã€‚ å¦‚æœé˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå–é˜Ÿå¤´æ•°æ®ï¼Œå°†è¯¥å¯¹è±¡ä¼ å…¥ process å‡½æ•°ï¼Œç”±ä¸Šå±‚æ¶ˆè´¹è€…è¿›è¡Œå¤„ç†ã€‚è‹¥ process å›è°ƒå‡½æ•°å¤„ç†å‡ºé”™ï¼Œåˆ™é‡æ–°å…¥é˜Ÿã€‚ æ‰€ä»¥æ•´ä½“æµç¨‹å¦‚å›¾ï¼š\nå°†å¯¹è±¡å­˜å‚¨è‡³ Indexer åï¼Œå°†èµ„æºå¯¹è±¡åˆ†å‘åˆ° SharedInformer å¯¹åº”çš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œåœ¨ Informer ä¸­æˆ‘ä»¬é€šè¿‡ informer.AddEventHandler æ·»åŠ äº†å¯¹èµ„æºäº‹ä»¶çš„å¤„ç†å‡½æ•°ã€‚å¯ä»¥çœ‹ä¸ªä¾‹å­\n3. Resync æœºåˆ¶\nä¸ºä»€ä¹ˆéœ€è¦ Resyncï¼Ÿ\né¦–å…ˆå›é¡¾ Informer çš„æ¶æ„å›¾ï¼Œä¸€å…±æœ‰ä¸‰æ–¹éœ€è¦åŒæ­¥æ•°æ®\né¦–å…ˆæ˜¯ apiserver ä¸ Informer ä¹‹é—´é€šè¿‡ resourceVersion ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚ ç„¶åæ˜¯ Informer å’Œ controller ä¹‹é—´ï¼šåç¨‹å°† FIFO é˜Ÿåˆ—ä¸­çš„äº‹ä»¶å–å‡ºæ›´æ–°è‡³ Indexer åï¼Œè¿˜ä¼šå°†äº‹ä»¶åŒæ­¥å›è°ƒè‡³ custom controllerï¼ŒåŠ å…¥åˆ° workqueue é˜Ÿåˆ—ä¸­ã€‚ ä½†æ˜¯åœ¨å¤„ç† Informer äº‹ä»¶å›è°ƒæ—¶ï¼Œå¹¶ä¸å…³å¿ƒå…¶è¿”å›çš„ç»“æœ:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // Informer çš„ Pop æ–¹æ³•çš„å›è°ƒå‡½æ•°æœ€åä¼šè°ƒç”¨åˆ°è¿™ä¸ªå‡½æ•° func processDeltas( // Object which receives event notifications from the given deltas handler ResourceEventHandler, clientState Store, deltas Deltas, isInInitialList bool, ) error { // from oldest to newest for _, d := range deltas { obj := d.Object switch d.Type { case Sync, Replaced, Added, Updated: //æŸ¥ä¸€ä¸‹æ˜¯å¦åœ¨Indexerç¼“å­˜ä¸­ å¦‚æœåœ¨ç¼“å­˜ä¸­å°±æ›´æ–°ç¼“å­˜ä¸­çš„å¯¹è±¡ if old, exists, err := clientState.Get(obj); err == nil \u0026amp;\u0026amp; exists { if err := clientState.Update(obj); err != nil { return err } handler.OnUpdate(old, obj) } else { //æ²¡æœ‰åœ¨Indexerç¼“å­˜ä¸­ æŠŠå¯¹è±¡æ’å…¥åˆ°ç¼“å­˜ä¸­ if err := clientState.Add(obj); err != nil { return err } handler.OnAdd(obj, isInInitialList) } ... } } return nil } å½“å‡ºç°å¤„ç†å¤±è´¥çš„æƒ…å†µæ—¶ï¼Œå®šæ—¶çš„ Resync è®©è¿™äº›å¤„ç†å¤±è´¥çš„äº‹ä»¶æœ‰äº†é‡æ–° onUpdate å¤„ç†çš„æœºä¼š\nResync åšäº†ä»€ä¹ˆï¼Ÿ\nResync çš„é€»è¾‘éå¸¸ç®€å•ï¼Œå°±æ˜¯å®šæ—¶å°†æœ¬åœ°ç¼“å­˜ï¼ˆIndexerï¼‰ä¸­æ‰€æœ‰çš„èµ„æºå¯¹è±¡é‡æ–°æ¨é€åˆ° DeltaFIFO ä¸­ï¼Œå¹¶è®¾å®šæ“ä½œç±»å‹ä¸º Syncã€‚\n4. SharedInformer æ¶ˆè´¹ Deltas\nä¸»è¦çœ‹å›è°ƒå‡½æ•° processDeltasï¼ˆè§ğŸ‘†ï¼‰\nIndexer Indexer è´Ÿè´£å­˜å‚¨èµ„æºå¯¹è±¡çš„å®Œæ•´å‰¯æœ¬å’Œæä¾›æŸ¥è¯¢åŠŸèƒ½ï¼Œç”¨äºå‡è½» API Server å’Œ Etcd çš„å‹åŠ›ã€‚\nIndexer æ˜¯åœ¨ ThreadSafeMap çš„åŸºç¡€ä¸Šè¿›è¡Œäº†å°è£…ï¼Œå®ƒç»§æ‰¿äº† ThreadSafeMap çš„ç›¸å…³æ–¹æ³•ï¼Œå¹¶å®ç°äº† Indexer Func ç­‰åŠŸèƒ½ â€”â€” æä¾›äº†ç´¢å¼•åŠŸèƒ½ã€‚\n1. ThreadSafeMap å¹¶å‘å®‰å…¨å­˜å‚¨\nTreadSafeMap ç»“æ„å¦‚ä¸‹ï¼š\n1 2 3 4 type threadSafeMap struct { item map[string] interface{} ... } item çš„ key é€šè¿‡ keyFunc å‡½æ•°è®¡ç®—ï¼Œé»˜è®¤ä½¿ç”¨ MetaNamespaceKeyFunc å‡½æ•°è®¡ç®—å‡º \u0026lt;namespace\u0026gt;/\u0026lt;name\u0026gt; æ ¼å¼çš„ keyï¼Œvalue ç”¨äºå­˜å‚¨èµ„æºå¯¹è±¡ã€‚\n2. Indexer ç´¢å¼•å™¨\nIndexer å¯ä»¥è‡ªå®šä¹‰ç´¢å¼•å‡½æ•°ï¼Œå®ƒæœ‰ 4 ä¸ªé‡è¦æ•°æ®ç»“æ„ï¼šIndicesã€Indexã€Indexers å’Œ IndexFuncã€‚\n1 2 3 4 5 6 7 type Indexers map[string]IndexFunc type IndexFunc func(obj interface{}) ([]string, error) type indices map[string]Index type index map[string]sets.String Indexersï¼šå­˜å‚¨ç´¢å¼•å™¨ï¼Œkey ä¸ºç´¢å¼•å™¨åç§°ï¼Œvalue ä¸ºç´¢å¼•å™¨çš„å®ç°å‡½æ•°ã€‚ IndexFuncï¼šç´¢å¼•å™¨å‡½æ•°ï¼Œå®šä¹‰ä¸ºæ¥æ”¶ä¸€ä¸ªèµ„æºå¯¹è±¡ï¼Œè¿”å›æ£€ç´¢ç»“æœåˆ—è¡¨ã€‚ Indicesï¼šå­˜å‚¨ç¼“å­˜å™¨ï¼Œkey ä¸ºç¼“å­˜å™¨åç§°ï¼Œvalue ä¸ºç¼“å­˜æ•°æ®ã€‚ Indexï¼šå­˜å‚¨ç¼“å­˜æ•°æ®ï¼Œå…¶ç»“æ„ä¸º K/Vã€‚ å¯ä»¥å…ˆæ¥çœ‹ä¸€ä¸ªè‡ªå®šä¹‰ç´¢å¼•çš„ä¾‹å­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 package main // å¯¼å…¥åŒ… import ( \u0026#34;fmt\u0026#34; \u0026#34;strings\u0026#34; \u0026#34;k8s.io/api/core/v1\u0026#34; metav1 \u0026#34;k8s.io/apimachinery/pkg/apis/meta/v1\u0026#34; \u0026#34;k8s.io/client-go/tools/cache\u0026#34; ) // å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºæ ¹æ® Pod å¯¹è±¡çš„ annotations å­—æ®µä¸­çš„ users å±æ€§ï¼Œç”Ÿæˆä¸€ä¸ªåŒ…å«æ‰€æœ‰ç”¨æˆ·åçš„å­—ç¬¦ä¸²åˆ‡ç‰‡ func UsersIndexFunc(obj interface{}) ([]string, error) { // è·å– Pod å¯¹è±¡ pod := obj.(*metav1.Pod) // è·å– users å±æ€§ usersString := pod.Annotations[\u0026#34;users\u0026#34;] // å°† users å±æ€§åˆ†å‰²ä¸ºå­—ç¬¦ä¸²åˆ‡ç‰‡ return strings.Split(usersString, \u0026#34;,\u0026#34;), nil } // ä¸»å‡½æ•° func main() { // æ ¹æ® UsersIndexFunc å»ºç«‹ç›¸åº”çš„ç´¢å¼•ç»“æ„ index := cache.NewIndexer(cache.MetaNamespaceKeyFunc, cache.Indexers{\u0026#34;byUser\u0026#34;: UsersIndexFunc}) // åˆ›å»ºä¸‰ä¸ª Pod å¯¹è±¡ pod1 := \u0026amp;metav1.Pod{ObjectMeta: metav1.ObjectMeta{Name: \u0026#34;one\u0026#34;, Annotations: map[string]string{\u0026#34;users\u0026#34;: \u0026#34;ernie,bert\u0026#34;}}} pod2 := \u0026amp;metav1.Pod{ObjectMeta: metav1.ObjectMeta{Name: \u0026#34;two\u0026#34;, Annotations: map[string]string{\u0026#34;users\u0026#34;: \u0026#34;bert,oscar\u0026#34;}}} pod3 := \u0026amp;metav1.Pod{ObjectMeta: metav1.ObjectMeta{Name: \u0026#34;tre\u0026#34;, Annotations: map[string]string{\u0026#34;users\u0026#34;: \u0026#34;ernie,elmo\u0026#34;}}} // å°† Pod å¯¹è±¡æ·»åŠ åˆ° cache.Indexer å¯¹è±¡ä¸­ index.Add(pod1) index.Add(pod2) index.Add(pod3) // ä»åˆšåˆšæ„å»ºçš„ç´¢å¼•ç»“æ„ä¸­ï¼Œè·å–æ‰€æœ‰åŒ…å«ç”¨æˆ·åä¸º \u0026#34;ernie\u0026#34; çš„ Pod å¯¹è±¡ erniePods, err := index.ByIndex(\u0026#34;byUser\u0026#34;, \u0026#34;ernie\u0026#34;) if err != nil { panic(err) } // éå†æ‰€æœ‰åŒ…å«ç”¨æˆ·åä¸º \u0026#34;ernie\u0026#34; çš„ Pod å¯¹è±¡ï¼Œå¹¶æ‰“å°å…¶åç§° for _, erniePod := range erniePods { fmt.Println(erniePod.(*metav1.Pod).Name) } } // è¾“å‡º one tre ä¸Šé¢çš„ä»£ç é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªç´¢å¼•å™¨å‡½æ•° UserIndexFuncï¼Œåœ¨è¯¥å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰æŸ¥è¯¢å‡ºæ‰€æœ‰ Pod èµ„æºä¸‹ Annotations å­—æ®µçš„ key ä¸º users çš„ Podã€‚\ncache.NewIndexer å‡½æ•°å®ä¾‹åŒ–äº† Indexer å¯¹è±¡ï¼Œå®ƒæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šç¬¬ä¸€ä¸ªæ˜¯ KeyFuncï¼Œç”¨äºè®¡ç®—èµ„æºå¯¹è±¡çš„ keyï¼›ç¬¬äºŒä¸ªæ˜¯ cache.Indexersï¼Œç”¨äºå®šä¹‰ç´¢å¼•å™¨ï¼Œå…¶ä¸­ key ä¸ºç´¢å¼•å™¨çš„åç§°ï¼ˆbyUserï¼‰ï¼Œvalue ä¸ºç´¢å¼•å™¨ã€‚é€šè¿‡ index.Add å‡½æ•°æ·»åŠ  3 ä¸ª Pod èµ„æºå¯¹è±¡ã€‚æœ€åé€šè¿‡ index.ByIndex å‡½æ•°æŸ¥è¯¢ byUser ç´¢å¼•å™¨ä¸‹åŒ¹é… ernie å­—æ®µçš„ Pod åˆ—è¡¨ã€‚\næ‰€ä»¥ Indexer ä¸­çš„ 4 ä¸ªç»“æ„ä¹‹é—´çš„ååŒå…³ç³»å¦‚ä¸‹ï¼š\næ ¹æ®è‡ªå®šä¹‰ç´¢å¼•å‡½æ•°å»ºç«‹ç´¢å¼•ç»“æ„ é€šè¿‡ Add æ–¹æ³•å°†èµ„æºå¯¹è±¡åŠ å…¥è¿™ä¸ªç´¢å¼•ç»“æ„ åˆ©ç”¨è¯¥ç´¢å¼•ç»“æ„æä¾›çš„ç´¢å¼•æ–¹æ³•è·å–æ»¡è¶³æ¡ä»¶çš„èµ„æºå¯¹è±¡çš„ key ç”¨è¿™ä¸ª key åˆ°çœŸæ­£å­˜å‚¨çš„åœ°æ–¹è·å–èµ„æºå¯¹è±¡ 3. ç´¢å¼•å™¨æ ¸å¿ƒå®ç°\n1 2 3 4 5 6 7 8 9 10 func (c *threadSafeMap) ByIndex(indexName, indexKey string) ([]interface{}, error) { indexFunc := c.indexers[indexName] // æŸ¥æ‰¾ç´¢å¼•åå¯¹åº”çš„ç´¢å¼•å‡½æ•° index := c.indices[indexName] // æŸ¥æ‰¾ç´¢å¼•åå¯¹åº”çš„ç¼“å­˜å™¨ set := index[indexKey] // ä» index ä¸­è·å–å¯¹åº”çš„æ•°æ® list := make([]interface{}, 0, set.Len()) for key := range set.List() { list = append(list, c.items[key]) } return list, nil } Index ç¼“å­˜æ•°æ®ä¸ºé›†åˆï¼ˆå…ƒç´ ä¸é‡å¤ï¼‰ã€‚ç”±äº Go æ ‡å‡†åº“æ²¡æœ‰æä¾› Set æ•°æ®ç»“æ„ï¼Œè€Œ Go ä¸­ map æ˜¯ä¸èƒ½å­˜åœ¨ç›¸åŒçš„ key çš„ï¼Œå› æ­¤ Kubernetes å°† map ç»“æ„ç±»å‹çš„ key ä½œä¸º Set æ•°æ®ç»“æ„ï¼Œå®ç°å»é‡ç‰¹æ€§ã€‚\nWorkQueue Event äº§ç”Ÿçš„é€Ÿåº¦æ¯”å¤„ç† Event çš„é€Ÿåº¦å¿«ï¼ŒWorkQueueå°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§é€Ÿåº¦ä¸ä¸€è‡´çš„é—®é¢˜è€Œå¼•å…¥çš„\nWorkQueue ç›¸æ¯”æ™®é€šçš„ FIFO ç›¸æ¯”æ”¯æŒï¼š\næœ‰åºï¼šæŒ‰æ·»åŠ é¡ºåºå¤„ç†å…ƒç´ ã€‚ å»é‡ï¼šç›¸åŒå…ƒç´ åœ¨åŒä¸€æ—¶é—´ä¸ä¼šè¢«é‡å¤å¤„ç†ã€‚ å¹¶å‘æ€§ï¼šå¤šç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ã€‚ æ ‡è®°æœºåˆ¶ï¼šæ”¯æŒæ ‡è®°ï¼Œæ ‡è®°ä¸€ä¸ªå…ƒç´ æ˜¯å¦è¢«å¤„ç†ï¼Œå…è®¸å…ƒç´ åœ¨å¤„ç†æ—¶é‡æ–°æ’é˜Ÿã€‚ é€šçŸ¥æœºåˆ¶ï¼šShutDown æ–¹æ³•é€šè¿‡ä¿¡å·é‡é€šçŸ¥é˜Ÿåˆ—ä¸å†æ¥æ”¶æ–°å…ƒç´ ã€‚ å»¶è¿Ÿï¼šæ”¯æŒå»¶è¿Ÿé˜Ÿåˆ—ï¼Œå»¶è¿Ÿä¸€æ®µæ—¶é—´åå†è¿›å°†å…ƒç´ å…¥é˜Ÿã€‚ é™é€Ÿï¼šæ”¯æŒé™é€Ÿé˜Ÿåˆ—ï¼Œé™åˆ¶ä¸€ä¸ªå…ƒç´ è¢«é‡æ–°æ’é˜Ÿçš„é€Ÿç‡ã€‚ Metricï¼šæ”¯æŒ metric ç›‘æ§æŒ‡æ ‡ï¼Œç”¨äº Prometheus ç›‘æ§ã€‚ WorkQueue æ”¯æŒ 3 ç§é˜Ÿåˆ—ï¼Œæä¾› 3 ç§æ¥å£ï¼š\nInterfaceï¼šFIFO é˜Ÿåˆ—æ¥å£ï¼Œæ”¯æŒå»é‡ã€‚ DelayInterfaceï¼šå»¶è¿Ÿé˜Ÿåˆ—æ¥å£ï¼ŒåŸºäº Interface å°è£…ã€‚ RatelimitingInterfaceï¼šé™é€Ÿé˜Ÿåˆ—æ¥å£ï¼ŒåŸºäº DelayInterface å°è£…ã€‚ FIFO é˜Ÿåˆ— æ–¹æ³•è¯´æ˜ï¼š\n1 2 3 4 5 6 7 8 type Interface interface { Add(item interface{}) // ç»™é˜Ÿåˆ—æ·»åŠ å…ƒç´ ï¼Œç±»å‹ä»»æ„ Len() int Get() (item interface{}, shutdown bool) // è·å–é˜Ÿå¤´å…ƒç´  Done(item interface{}) // æ ‡è®°å…ƒç´ å·²è¢«å¤„ç† ShutDown() // å…³é—­é˜Ÿåˆ— ShuttingDown() bool // æŸ¥è¯¢é˜Ÿåˆ—æ˜¯å¦æ­£åœ¨è¢«å…³é—­ } FIFO æ•°æ®ç»“æ„å®šä¹‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 type Type struct { queue []t // å®é™…å­˜å‚¨å…ƒç´ çš„åœ°æ–¹ dirty set // ä¿è¯å»é‡ï¼Œå¹¶ä¸”ä¿è¯åŒä¸€ä¸ªå…ƒç´ è¢«å¹¶å‘æ·»åŠ å¤šæ¬¡ï¼Œä¹Ÿåªä¼šè¢«å¤„ç†ä¸€æ¬¡ processing set // æ ‡è®°ä¸€ä¸ªå…ƒç´ æ˜¯å¦è¢«æ­£å¸¸å¤„ç† cond *sync.Cond shuttingDown bool metrics queueMetrics unfinishedWorkUpdatePeriod time.Duration clock clock.Clock } å­˜å‚¨è¿‡ç¨‹å¦‚å›¾ï¼š\né€šè¿‡ Add æ–¹æ³•å¾€ FIFO ä¸­æ’å…¥ä¸‰ä¸ªå…ƒç´ ã€‚ é€šè¿‡ Get æ–¹æ³•è·å–æœ€å…ˆè¿›å…¥çš„å…ƒç´ ï¼Œæ”¾å…¥ processing é˜Ÿåˆ—ã€‚ é€šè¿‡ Done æ–¹æ³•æ ‡è®°è¯¥å…ƒç´ å·²ç»è¢«å¤„ç†å®Œæˆï¼Œå¹¶ä» processing é˜Ÿåˆ—ä¸­å‡ºé˜Ÿã€‚ FIFO å¹¶å‘å­˜å‚¨è¿‡ç¨‹ï¼š\ngoroutine A é€šè¿‡ Get è·å–é˜Ÿåˆ— 1 å…ƒç´ ï¼Œå°†å…¶æ·»åŠ åˆ° processing é˜Ÿåˆ—ã€‚ åŒä¸€æ—¶é—´ï¼Œgoroutine B é€šè¿‡ Add æ–¹æ³•æ’å…¥å¦ä¸€ä¸ª 1 å…ƒç´ ã€‚ æ­¤æ—¶ç”±äºåœ¨ processing é˜Ÿåˆ—å·²ç»å­˜åœ¨ç›¸åŒçš„å…ƒç´ ï¼Œæ‰€ä»¥åé¢çš„ 1 å…ƒç´ ä¸ä¼šç›´æ¥æ·»åŠ åˆ° queue å­—æ®µä¸­ï¼Œè€Œæ˜¯æ·»åŠ åˆ° dirtyã€‚ å½“ goroutine A é€šè¿‡ Done æ ‡è®°å¤„ç†å®Œæˆåï¼Œå¦‚æœ dirty å­—æ®µä¸­æœ‰ 1 å…ƒç´ ï¼Œåˆ™å°†å…¶è¿½åŠ åˆ° queue å­—æ®µå°¾éƒ¨ã€‚ å»¶è¿Ÿé˜Ÿåˆ— å»¶è¿Ÿé˜Ÿåˆ—åŸºäº FIFO é˜Ÿåˆ—æ¥å£ï¼Œæ–°å¢äº† AddAfter æ–¹æ³•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 type DelayingInterface interface { Interface AddAfter(item interface{}, duration time.Duration) } type delayingType struct { Interface clock clock.Clock stopCh chan struct{} heartbeat clock.Ticker waitingForAddCh chan *waitFor // waitchan é»˜è®¤å¤§å° 1000 metrics retryMetrics deprecatedMetrics retryMetrics } type waitFor struct { data t // å‡†å¤‡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„æ•°æ® readyAt time.Time // åº”è¯¥è¢«åŠ å…¥é˜Ÿåˆ—çš„æ—¶é—´ index int // åœ¨ waitForPriorityQueueï¼ˆå°é¡¶å †ï¼‰ä¸­çš„ç´¢å¼• } å…¶ä¸­æœ€ä¸»è¦çš„å­—æ®µæ˜¯ waitingForAddCh ï¼Œé»˜è®¤å¤§å° 1000ã€‚\nå»¶è¿Ÿé˜Ÿåˆ—é€šè¿‡ AddAfter æ–¹æ³•æ’å…¥å…ƒç´ ï¼Œå½“æ’å…¥çš„å…ƒç´ å¤§å°å¤§äºç­‰äº 1000 æ—¶ï¼Œå»¶è¿Ÿé˜Ÿåˆ—é˜»å¡ã€‚è¿è¡ŒåŸç†ï¼š\né€šè¿‡ AddAfter å°†å…ƒç´ åŠ å…¥ waitingForAddChï¼ŒwaitingLoop æ¥æ¶ˆè´¹å…ƒç´ ã€‚å½“å…ƒç´ çš„å»¶è¿Ÿæ—¶é—´æœªåˆ°è¾¾æ—¶ï¼Œåˆ™å°†å…ƒç´ æ”¾å…¥æŒ‰å»¶è¿Ÿæ—¶é—´æ’åºçš„ä¼˜å…ˆé˜Ÿåˆ—ï¼ˆwaitForPriorityQueueï¼‰ä¸­ã€‚å½“å…ƒç´ å»¶è¿Ÿæ—¶é—´åˆ°è¾¾æ—¶ï¼Œå°†å…ƒç´ æ’å…¥ FIFO é˜Ÿåˆ—ï¼Œå¹¶éå†ä¼˜å…ˆé˜Ÿåˆ—ï¼ŒæŒ‰ä¸Šè¿°é€»è¾‘éªŒè¯æ—¶é—´ã€‚\né™é€Ÿé˜Ÿåˆ— åŸºäºå»¶è¿Ÿé˜Ÿåˆ—å’Œ FIFO é˜Ÿåˆ—æ¥å£å°è£…ï¼Œåœ¨åŸæœ‰çš„åŠŸèƒ½ä¸Šå¢åŠ äº† AddRateLimitedã€Forgetã€NumRequeues æ–¹æ³•ã€‚\né™é€Ÿé˜Ÿåˆ—çš„é‡ç‚¹åœ¨äºå®ƒæä¾›çš„ 4 ç§é™é€Ÿç®—æ³•æ¥å£ï¼ˆRateLimiterï¼‰ã€‚å®ƒçš„åŸç†æ˜¯åˆ©ç”¨å»¶è¿Ÿé˜Ÿåˆ—çš„ç‰¹æ€§ï¼Œå»¶è¿ŸæŸä¸ªå…ƒç´ çš„æ’å…¥æ—¶é—´ï¼Œè¾¾åˆ°é™é€Ÿç›®çš„ã€‚\né™é€Ÿé˜Ÿåˆ—æ¥å£æ–¹æ³•ï¼š\n1 2 3 4 5 type RateLimiter interface { When(item interface{}) time.Duration // è·å–æŒ‡å®šå…ƒç´ åº”è¯¥ç­‰å¾…çš„æ—¶é—´ Forget(item interface{}) // é‡Šæ”¾æŒ‡å®šå…ƒç´ ï¼Œæ¸…ç©ºè¯¥å…ƒç´ çš„æ’é˜Ÿæ•° NumRequeues(item interface{}) int // è·å–æŒ‡å®šå…ƒç´ çš„æ’é˜Ÿæ•° } å¼•å…¥ä¸€ä¸ªæ¦‚å¿µ â€”â€” é™é€Ÿå‘¨æœŸï¼šä»æ‰§è¡Œ AddRateLimited æ–¹æ³•åˆ°æ‰§è¡Œå®Œ Forget æ–¹æ³•ä¹‹é—´çš„æ—¶é—´ã€‚\n1. ä»¤ç‰Œæ¡¶ç®—æ³•\né€šè¿‡ Go ä¸‰æ–¹åº“ golang.org/x/time/rate å®ç°ã€‚ä»¤ç‰Œæ¡¶ç®—æ³•å†…éƒ¨å®ç°äº†ä¸€ä¸ªå­˜æ”¾ token çš„æ¡¶ï¼Œåˆå§‹æ¡¶ä¸ºç©ºï¼Œtoken ä¼šä»¥å›ºå®šé€Ÿç‡å¾€æ¡¶é‡Œå¡«å……ï¼Œç›´åˆ°å¡«æ»¡ï¼Œå¤šä½™çš„ token ä¼šè¢«ä¸¢å¼ƒã€‚æ¯ä¸ªå…ƒç´ éƒ½ä¼šä»ä»¤ç‰Œæ¡¶ä¸­å¾—åˆ°ä¸€ä¸ª tokenï¼Œåªæœ‰å¾—åˆ° token çš„å…ƒç´ æ‰èƒ½è¢« acceptï¼Œå¦åˆ™å¤„äºç­‰å¾…çŠ¶æ€ã€‚å³é€šè¿‡æ§åˆ¶å‘æ”¾ token çš„é€Ÿç‡è¾¾åˆ°é™é€Ÿç›®çš„ã€‚\n2. æ’é˜ŸæŒ‡æ•°ç®—æ³•\næ’é˜ŸæŒ‡æ•°ç®—æ³•å°†ç›¸åŒå…ƒç´ çš„æ’é˜Ÿæ•°ä½œä¸ºæŒ‡æ•°ï¼Œæ’é˜Ÿæ•°å¢å¤§ï¼Œé€Ÿç‡é™åˆ¶å‘ˆæŒ‡æ•°çº§å¢é•¿ï¼Œä½†å…¶æœ€å¤§ä¸ä¼šè¶…è¿‡ maxDelayã€‚æ ¸å¿ƒå®ç°ï¼š\n1 2 3 4 5 6 exp := r.failures[item] r.failures[item] = r.failures[item] + 1 backoff := float64(r.baseDelay.Nanoseconds()) * math.Pow(2, float64(exp)) if backoff \u0026gt; math.MaxInt64 { return r.maxDelay } å…¶ä¸­ï¼Œfailures ç”¨äºç»Ÿè®¡å…ƒç´ æ’é˜Ÿæ•°ï¼Œæ¯å½“ AddRateLimited æ’å…¥æ–°å…ƒç´ ï¼Œè¯¥å­—æ®µåŠ  1ï¼›baseDelay æ˜¯æœ€åˆé™é€Ÿï¼ˆç³»æ•°ï¼Œé»˜è®¤ 5 msï¼‰ï¼ŒmaxDelay æ˜¯æœ€å¤§é™é€Ÿå•ä½ï¼ˆé»˜è®¤ 1000 sï¼‰ã€‚ å»¶è¿Ÿæ—¶é—´çš„è®¡ç®—å…¬å¼å¯ä»¥æ€»ç»“ä¸ºï¼š$back off = baseDeley * 2^{\\exp}$ï¼Œå…¶ä¸­ exp ä¸ºæ’é˜Ÿæ•°ã€‚\n3. è®¡æ•°å™¨ç®—æ³•\né€šè¿‡ é™åˆ¶ä¸€æ®µæ—¶é—´å†…å…è®¸é€šè¿‡å…ƒç´ æ•° è¾¾åˆ°é™é€Ÿç›®çš„ã€‚æ¯æ’å…¥ä¸€ä¸ªå…ƒç´ ï¼Œè®¡æ•°å™¨åŠ  1ï¼Œå½“è®¡æ•°å™¨åˆ°è¾¾é˜ˆå€¼å¹¶ä¸”è¿˜åœ¨é™é€Ÿå‘¨æœŸå†…æ—¶ï¼Œåˆ™ä¸å…è®¸å…ƒç´ é€šè¿‡ã€‚WorkQueue åœ¨æ­¤åŸºç¡€ä¸Šæ‰©å±•äº†ä¸¤ç§å»¶è¿Ÿé€Ÿç‡ï¼š\n1 2 3 4 5 r.failures[item] = r.failures[item] + 1 if r.failures[item] \u0026lt;= r.maxFastAttempts { return fastDelay } return slowDelay 4. æ··åˆæ¨¡å¼\nå°†å¤šç§é™é€Ÿç®—æ³•æ··åˆä½¿ç”¨ï¼Œå¦‚åŒæ—¶ä½¿ç”¨æ’é˜ŸæŒ‡æ•°ç®—æ³•å’Œä»¤ç‰Œæ¡¶ç®—æ³•ï¼š\n1 2 3 4 5 6 func DefaultControllerRateLimiter() RateLimiter { return NewMaxOfRateLimiter( NewItemExponentialFailureRateLimiter(5*time.Millisecond, 1000*time.Second), \u0026amp;BucketRateLimiter{limiter: rate.NewLimiter(rate.Limit(10), 100)}, ) } EventBroadcaster äº‹ä»¶ç®¡ç†å™¨ è¿™é‡Œçš„ Event æ˜¯ Kubernetes æ‰€ç®¡ç†çš„ Event èµ„æºå¯¹è±¡ï¼Œè€Œé Etcd é›†ç¾¤ç›‘æ§æœºåˆ¶äº§ç”Ÿçš„å›è°ƒäº‹ä»¶ï¼Œæ³¨æ„åŒºåˆ†ã€‚\nEvent ä½œä¸ºä¸€ç§é›†ç¾¤èµ„æºä¿å­˜åœ¨ Etcd ä¸­ï¼Œä¸ºäº†é¿å…ç£ç›˜ç©ºé—´è¢«å¡«æ»¡ï¼Œåªä¿ç•™æœ€è¿‘ 1 å°æ—¶çš„äº‹ä»¶ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // Event æ•°æ®ç»“æ„å®šä¹‰ type Event struct { metav1.TypeMeta metav1.ObjectMeta InvolvedObject ObjectReference Reason string Message string Source EventSource FirstTimestamp metav1.Time LastTimestamp metav1.Time Count int32 Type string EventTime metav1.MicroTime Series *EventSeries Action string Related *ObjectReference ReportingController string ReportingInstance string } EventBroadcaster äº‹ä»¶ç®¡ç†æœºåˆ¶åŸç†å›¾ï¼š\nåœ¨å®šä½ä¸Šï¼Œå¯ä»¥æŠŠ EventBroadcaster ç†è§£æˆé›†æˆåœ¨å„ä¸ªç»„ä»¶ä¸­çš„ä¸€å¥— SDKï¼Œå®ƒå¯ä»¥ç”¨æ¥äº§ç”Ÿå’Œåˆ†å‘äº‹ä»¶ã€‚å…¶ä¸­ä¸»è¦æœ‰ä¸‰ä¸ªç»„ä»¶ï¼š\nEventRecorderï¼šäº‹ä»¶ç”Ÿäº§è€…ã€‚Kubernetes ç»„ä»¶é€šè¿‡ EventRecorder è®°å½•å…³é”®æ€§äº‹ä»¶ã€‚ EventBroadcasterï¼šäº‹ä»¶æ¶ˆè´¹è€…ã€‚æ¶ˆè´¹ EventRecorder è®°å½•çš„äº‹ä»¶å¹¶åˆ†å‘ç»™æ‰€æœ‰å·²è¿æ¥çš„ broadcasterWatcherã€‚æœ‰éé˜»å¡åˆ†å‘å’Œé˜»å¡åˆ†å‘æœºåˆ¶ã€‚ broadcasterWatcherï¼šç”¨äºå®šä¹‰äº‹ä»¶çš„å¤„ç†æ–¹å¼ï¼Œå¦‚ä¸ŠæŠ¥åˆ° API Serverã€‚ 1. EventRecorder\nEventRecorder æ¥å£æ–¹æ³•ä»¥åŠä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 type EventRecorder interface { Event(...) // è®°å½•åˆšå‘ç”Ÿçš„äº‹ä»¶ Eventf(...) // æ ¼å¼åŒ–è¾“å‡ºäº‹ä»¶çš„æ ¼å¼ PastEventf(...) // å…è®¸è‡ªå®šä¹‰äº‹ä»¶å‘ç”Ÿçš„äº‹ä»¶ï¼Œä»¥è®°å½•å·²å‘ç”Ÿè¿‡çš„æ¶ˆæ¯ AnnotatedEventf(...) // åŠŸèƒ½ä¸ Eventf ä¸€æ ·ï¼Œæ·»åŠ äº† Annotation å­—æ®µ } // Event æœ€ç»ˆä¼šè°ƒç”¨åˆ° Action å‡½æ•°å¼‚æ­¥åœ°å°†äº‹ä»¶å†™å…¥ m.incoming Chanã€‚ func (m *Broadcaster) Action(action EventType, obj runtime.Object) { m.incoming \u0026lt;- Event{action, obj} } 2. EventBroadcaster\n1 2 3 4 // EventBroadcaster å®ä¾‹åŒ–ç¤ºä¾‹ func NewBroadcaster() EventBroadcaster { return \u0026amp;eventBroadcasterImpl{watch.NewBroadcaster(maxQueuedEvents, watch.DropIfChannelFull), defaultSleepDuration} } watch.NewBroadcaster ä¼šåœ¨å‡½æ•°å†…éƒ¨å¯åŠ¨ goroutine ç›‘æ§ m.incomingï¼Œå¹¶å°†ç›‘æ§çš„äº‹ä»¶é€šè¿‡ m.distribute å‡½æ•°åˆ†å‘ç»™æ‰€æœ‰å·²è¿æ¥çš„ broadcasterWatcherã€‚\nåˆ†å‘æœ‰ä¸¤ç§æœºåˆ¶ï¼šéé˜»å¡åˆ†å‘æœºåˆ¶ å’Œ é˜»å¡åˆ†å‘æœºåˆ¶ã€‚å…¶ä¸­ï¼Œéé˜»å¡åˆ†å‘ç”¨ DropIfChannelFull æ ‡è¯†ï¼Œé˜»å¡åˆ†å‘ç”¨ WaitIfChannelFull æ ‡è¯†ï¼Œé»˜è®¤ä¸ºéé˜»å¡ï¼Œç¤ºä¾‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func (m *Broadcaster) distribute(event Event) { m.lock.Lock() defer m.lock.Unlock() if m.fullChannelBehavior == DropIfChannelFull { for _, w := range m.watchers { select { case w.result \u0026lt;- event: case \u0026lt;-w.stopped: default: } } } else { for _, w := range m.watchers { select { case w.result \u0026lt;- event: case \u0026lt;-w.stopped: } } } } éé˜»å¡ä½¿ç”¨ select ä¸­çš„ default å…³é”®å­—å®ç°ï¼Œå½“ç¼“å†²åŒºæ»¡æ—¶ï¼Œäº‹ä»¶ä¸¢å¤±ã€‚è€Œé˜»å¡æ–¹å¼åœ¨ç¼“å†²åŒºæ»¡æ—¶ä¼šé€‰æ‹©ç­‰å¾…ã€‚\nKubernetes ä¸­çš„äº‹ä»¶èµ„æºä¸å…¶ä»–èµ„æºä¸åŒçš„æ˜¯å®ƒå¯ä»¥ä¸¢å¤±ã€‚\n3. broadcasterWatcher\nbroadcasterWatcher æ˜¯æ¯ä¸ªç³»ç»Ÿç»„ä»¶è‡ªå®šä¹‰å¤„ç†äº‹ä»¶çš„æ–¹å¼ã€‚æ¯ä¸ª broadcasterWatcher æœ‰ä¸¤ç§è‡ªå®šä¹‰å¤„ç†äº‹ä»¶çš„å‡½æ•°ï¼š\nStartLoggingï¼šå°†äº‹ä»¶å†™å…¥æ—¥å¿—ã€‚ StartRecordingToSinkï¼šå°†äº‹ä»¶ä¸ŠæŠ¥åˆ° API Server å¹¶å­˜åˆ° Etcdã€‚ ä¸Šé¢è¿™ä¸¤ä¸ªå‡½æ•°éƒ½ä¾èµ–äº StartEventWatcher å‡½æ•°ï¼Œå…¶å†…éƒ¨è·‘äº†ä¸€ä¸ª goroutineï¼Œä¸æ–­ç›‘æ§ EventBroadcaster æ¥å‘ç°äº‹ä»¶å¹¶è°ƒç”¨ç›¸å…³å‡½æ•°å¯¹äº‹ä»¶å¤„ç†ã€‚\nä»¥ kube-scheduler ç»„ä»¶ä¸ºä¾‹ï¼š\n1 2 3 4 5 if cc.Broadcaster != nil \u0026amp;\u0026amp; cc.EventClient != nil { cc.Broadcaster.StartLogging(klog.V(6).Info()) cc.Broadcaster.StartRecordingToSink(\u0026amp;v1core. EventSinkImpl{Interface: cc.EventClient.Events(\u0026#34;\u0026#34;)}) } å®ƒå°† v1core.EventSinkImpl ä½œä¸ºä¸ŠæŠ¥äº‹ä»¶çš„è‡ªå®šä¹‰å‡½æ•°ã€‚ä¸ŠæŠ¥äº‹ä»¶æœ‰ 3 ç§æ–¹æ³•ï¼šCreateï¼ˆPost æ–¹æ³•ï¼‰ã€Updateï¼ˆPut æ–¹æ³•ï¼‰ã€Patchï¼ˆPatch æ–¹æ³•ï¼‰ã€‚ä»¥ Create ä¸ºä¾‹ï¼ŒCreate =\u0026gt; e.Interface.CreateWithEventNamespaceï¼š\n1 2 3 4 5 6 7 8 9 func (e *events) CreateWithEventNamespace(event *v1.Event) (*v1.Event, error) { ... result := \u0026amp;v1.Event{} err := e.client.Post(). NamespaceIfScoped(event.Namespace, len(event.Namespace) \u0026gt; 0). Resource(\u0026#34;events\u0026#34;). Body(event). Do(). } ä¸ŠæŠ¥è¿‡ç¨‹é€šè¿‡ RESTClient å‘é€ Post è¯·æ±‚ï¼Œå°†äº‹ä»¶å‘é€åˆ° API Serverï¼Œæœ€ç»ˆå­˜åœ¨ Etcdã€‚\n","date":"0001-01-01T00:00:00Z","permalink":"https://pypotato.github.io/p/","title":""},{"content":"This is a test page ","date":"0001-01-01T00:00:00Z","permalink":"https://pypotato.github.io/p/","title":""}]