<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="ã€ŠKubernetes æºç å‰–æã€‹ç¬”è®° Kubernetes ç‰ˆæœ¬ï¼š1.14 ç¬¬ 5 ç« ï¼šclient-go ç¼–ç¨‹å¼äº¤äº’ Client å®¢æˆ·ç«¯å¯¹è±¡ client-go æ”¯æŒ 4 ç§ Client å®¢æˆ·ç«¯å¯¹è±¡æ¥ä¸ Kubernetes API Server äº¤äº’ï¼š å…¶"><title></title>
<link rel=canonical href=https://pypotato.github.io/p/><link rel=stylesheet href=/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css><meta property="og:title" content><meta property="og:description" content="ã€ŠKubernetes æºç å‰–æã€‹ç¬”è®° Kubernetes ç‰ˆæœ¬ï¼š1.14 ç¬¬ 5 ç« ï¼šclient-go ç¼–ç¨‹å¼äº¤äº’ Client å®¢æˆ·ç«¯å¯¹è±¡ client-go æ”¯æŒ 4 ç§ Client å®¢æˆ·ç«¯å¯¹è±¡æ¥ä¸ Kubernetes API Server äº¤äº’ï¼š å…¶"><meta property="og:url" content="https://pypotato.github.io/p/"><meta property="og:site_name" content="æ¼”ç¤ºç«™ç‚¹"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta name=twitter:title content><meta name=twitter:description content="ã€ŠKubernetes æºç å‰–æã€‹ç¬”è®° Kubernetes ç‰ˆæœ¬ï¼š1.14 ç¬¬ 5 ç« ï¼šclient-go ç¼–ç¨‹å¼äº¤äº’ Client å®¢æˆ·ç«¯å¯¹è±¡ client-go æ”¯æŒ 4 ç§ Client å®¢æˆ·ç«¯å¯¹è±¡æ¥ä¸ Kubernetes API Server äº¤äº’ï¼š å…¶"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huda2458f72ce188392d75c5d51cd8e24e_373_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ¥</span></figure><div class=site-meta><h1 class=site-name><a href=/>æ¼”ç¤ºç«™ç‚¹</a></h1><h2 class=site-description>Lorem ipsum dolor sit amet, consectetur adipiscing elit.</h2></div></header><ol class=social-menu><li><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>ä¸»é¡µ</span></a></li><li><a href=/%E5%85%B3%E4%BA%8E/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>å…³äº</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://pypotato.github.io/en/>English</option><option value=https://pypotato.github.io/ selected>ä¸­æ–‡</option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>æš—è‰²æ¨¡å¼</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#ç¬¬-5-ç« client-go-ç¼–ç¨‹å¼äº¤äº’>ç¬¬ 5 ç« ï¼šclient-go ç¼–ç¨‹å¼äº¤äº’</a><ol><li><a href=#client-å®¢æˆ·ç«¯å¯¹è±¡>Client å®¢æˆ·ç«¯å¯¹è±¡</a><ol><li><a href=#kubeconfig-é…ç½®ç®¡ç†>kubeconfig é…ç½®ç®¡ç†</a></li><li><a href=#restclient-å®¢æˆ·ç«¯>RESTClient å®¢æˆ·ç«¯</a></li><li><a href=#clientset-å®¢æˆ·ç«¯>ClientSet å®¢æˆ·ç«¯</a></li><li><a href=#dynamicclient-å®¢æˆ·ç«¯>DynamicClient å®¢æˆ·ç«¯</a></li><li><a href=#discoveryclient-å®¢æˆ·ç«¯>DiscoveryClient å®¢æˆ·ç«¯</a></li></ol></li><li><a href=#informer-æœºåˆ¶>Informer æœºåˆ¶</a><ol><li><a href=#informer-æœºåˆ¶æ¶æ„è®¾è®¡>Informer æœºåˆ¶æ¶æ„è®¾è®¡</a></li><li><a href=#reflector>Reflector</a></li><li><a href=#deltafifo>DeltaFIFO</a></li><li><a href=#indexer>Indexer</a></li></ol></li><li><a href=#workqueue>WorkQueue</a><ol><li><a href=#fifo-é˜Ÿåˆ—>FIFO é˜Ÿåˆ—</a></li><li><a href=#å»¶è¿Ÿé˜Ÿåˆ—>å»¶è¿Ÿé˜Ÿåˆ—</a></li><li><a href=#é™é€Ÿé˜Ÿåˆ—>é™é€Ÿé˜Ÿåˆ—</a></li></ol></li><li><a href=#eventbroadcaster-äº‹ä»¶ç®¡ç†å™¨>EventBroadcaster äº‹ä»¶ç®¡ç†å™¨</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/p/></a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>é˜…è¯»æ—¶é•¿: 1 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><h1 id=kubernetes-æºç å‰–æç¬”è®°>ã€ŠKubernetes æºç å‰–æã€‹ç¬”è®°</h1><p>Kubernetes ç‰ˆæœ¬ï¼š1.14</p><h2 id=ç¬¬-5-ç« client-go-ç¼–ç¨‹å¼äº¤äº’>ç¬¬ 5 ç« ï¼šclient-go ç¼–ç¨‹å¼äº¤äº’</h2><h3 id=client-å®¢æˆ·ç«¯å¯¹è±¡>Client å®¢æˆ·ç«¯å¯¹è±¡</h3><p>client-go æ”¯æŒ 4 ç§ Client å®¢æˆ·ç«¯å¯¹è±¡æ¥ä¸ Kubernetes API Server äº¤äº’ï¼š</p><p><img src=/images/Client.png loading=lazy alt=pic></p><p>å…¶ä¸­ RESTClient æ˜¯æœ€åŸºç¡€çš„å®¢æˆ·ç«¯ã€‚RESTClient å¯¹ HTTP Request è¿›è¡Œäº†å°è£…ï¼Œå®ç°äº† RESTful é£æ ¼çš„ APIã€‚å…¶ä»–ä¸‰ç§å®¢æˆ·ç«¯éƒ½æ˜¯åŸºäº RESTClient å®ç°çš„ã€‚</p><ul><li><strong>Clientset</strong>ï¼š æ˜¯å¤šä¸ª Client å®¢æˆ·ç«¯çš„é›†åˆï¼Œ<strong>åªèƒ½å¤„ç† K8s å†…ç½®èµ„æº</strong>ã€‚</li><li><strong>dynamicClient</strong>ï¼š åŠ¨æ€å®¢æˆ·ç«¯ï¼Œ<strong>å¯ä»¥æ“ä½œä»»æ„ k8s èµ„æºï¼ŒåŒ…æ‹¬CRDèµ„æº</strong>ã€‚</li></ul><h4 id=kubeconfig-é…ç½®ç®¡ç†>kubeconfig é…ç½®ç®¡ç†</h4><p>kubeconfig ç”¨äºç®¡ç†è®¿é—® kube-apiserver çš„é…ç½®ä¿¡æ¯ï¼ŒåŒæ—¶å®ƒè¿˜<strong>æ”¯æŒè®¿é—®å¤š kube-apiserverçš„é…ç½®ç®¡ç†</strong>ï¼ŒKubernetes çš„å…¶ä»–ç»„ä»¶éƒ½ä½¿ç”¨ kubeconfig é…ç½®ä¿¡æ¯æ¥è¿æ¥ kube-apiserver ç»„ä»¶ã€‚</p><p>kubeconfig ç§å­˜å‚¨äº†é›†ç¾¤ã€ç”¨æˆ·ã€å‘½åç©ºé—´å’Œèº«ä»½éªŒè¯ç­‰ä¿¡æ¯ï¼Œä»–é€šå¸¸åŒ…å« 3 éƒ¨åˆ†ï¼š</p><ul><li><strong>clusters</strong>ï¼šå®šä¹‰é›†ç¾¤ä¿¡æ¯ï¼Œå¦‚ kube-apiserver çš„æœåŠ¡åœ°å€åŠé›†ç¾¤çš„è¯ä¹¦ä¿¡æ¯ç­‰ã€‚</li><li><strong>users</strong>ï¼šå®šä¹‰äº†é›†ç¾¤ç”¨æˆ·èº«ä»½éªŒè¯çš„å®¢æˆ·ç«¯å‡­æ®ã€‚</li><li><strong>contexts</strong>ï¼šå®šä¹‰é›†ç¾¤ç”¨æˆ·ä¿¡æ¯å’Œå‘½åç©ºé—´ç­‰ï¼Œç”¨äºå°†è¯·æ±‚å‘é€åˆ°æŒ‡å®šçš„é›†ç¾¤ã€‚</li></ul><p>client-go ä¼šè¯»å– kubeconfig é…ç½®ä¿¡æ¯ï¼Œå¹¶ç”Ÿæˆ config å¯¹è±¡ï¼Œç”¨äºä¸ kube-apiserver é€šä¿¡ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>config</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>clientcmd</span><span class=p>.</span><span class=nf>BuildConfigFromFlag</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>clientcmd</span><span class=p>.</span><span class=nx>RecommendedHomeFile</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=restclient-å®¢æˆ·ç«¯>RESTClient å®¢æˆ·ç«¯</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>restClient</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rest</span><span class=p>.</span><span class=nf>RESTClientFor</span><span class=p>(</span><span class=nx>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>result</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>PodList</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>restClient</span><span class=p>.</span><span class=nf>Get</span><span class=p>().</span>
</span></span><span class=line><span class=cl>        <span class=nf>Namespace</span><span class=p>(</span><span class=s>&#34;default&#34;</span><span class=p>).</span>
</span></span><span class=line><span class=cl>        <span class=nf>Resource</span><span class=p>(</span><span class=s>&#34;pods&#34;</span><span class=p>).</span>
</span></span><span class=line><span class=cl>        <span class=nf>VersionedParams</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>ListOptions</span><span class=p>{</span><span class=nx>limit</span><span class=p>:</span><span class=mi>500</span><span class=p>},</span><span class=nx>scheme</span><span class=p>.</span><span class=nx>ParameterCodec</span><span class=p>).</span>
</span></span><span class=line><span class=cl>        <span class=nf>Do</span><span class=p>().</span>
</span></span><span class=line><span class=cl>        <span class=nf>Into</span><span class=p>(</span><span class=nx>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šé¢çš„ä»£ç ç”¨ config å¯¹è±¡å®ä¾‹åŒ–äº† RESTClient å¯¹è±¡ï¼Œè¿›è€Œæ„å»º HTTP è¯·æ±‚å‚æ•°ã€‚RESTClient å‘é€è¯·æ±‚çš„è¿‡ç¨‹å¯¹ Go è¯­è¨€æ ‡å‡†åº“ net/http è¿›è¡Œäº†å°è£…ï¼Œç”± Do å‡½æ•°å®ç°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// file: staging/src/k8s.io/client-go/rest/request.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>Request</span><span class=p>)</span> <span class=nf>Do</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=nx>Result</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>result</span> <span class=nx>Result</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>request</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>req</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span> <span class=nx>resp</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>result</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>transformResponse</span><span class=p>(</span><span class=nx>resp</span><span class=p>,</span> <span class=nx>req</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=clientset-å®¢æˆ·ç«¯>ClientSet å®¢æˆ·ç«¯</h4><p>RESTClient ä½œä¸ºä¸€ç§æœ€åŸºç¡€çš„å®¢æˆ·ç«¯ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™éœ€è¦æŒ‡å®š Resource å’Œ Version ç­‰ä¿¡æ¯ï¼Œç¼–ç æ—¶éœ€è¦æå‰çŸ¥é“ Resource æ‰€åœ¨çš„ Group å’Œå¯¹åº”çš„ Version ä¿¡æ¯ï¼ˆå…·ä½“å®è·µå¯ä»¥åœ¨ <a class=link href="https://www.bilibili.com/video/BV1uS4y1V7iZ/?spm_id_from=333.788&amp;vd_source=cecd7267d218709c07ce8584d7134038" target=_blank rel=noopener>b ç«™è§†é¢‘</a> ä¸­çœ‹åˆ°ï¼‰ã€‚</p><p><img src=/images/restclient-gv.png loading=lazy alt="Alt text"></p><p>ä¸ä¹‹ç›¸æ¯”ï¼ŒClientSet ä½¿ç”¨èµ·æ¥æ›´åŠ ä¾¿æ·ï¼Œå®ƒ<strong>åœ¨ RESTClient çš„åŸºç¡€ä¸Šå°è£…äº†å¯¹ Resource å’Œ Version çš„ç®¡ç†æ–¹æ³•</strong>ã€‚</p><p>æ¯ä¸€ä¸ª Resource å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œè€Œ ClientSet æ˜¯å¤šä¸ªå®¢æˆ·ç«¯çš„é›†åˆï¼Œæ¯ä¸€ä¸ª Resource å’Œ Version éƒ½ä»¥å‡½æ•°çš„æ–¹å¼æš´éœ²ç»™å¼€å‘è€…ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>clientSet</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>kubernetes</span><span class=p>.</span><span class=nf>NewForConfig</span><span class=p>(</span><span class=nx>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ¯ä¸€ä¸ª Resource å’Œ Version éƒ½ä»¥å‡½æ•°çš„æ–¹å¼æš´éœ²ç»™å¼€å‘è€…
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>podClient</span> <span class=o>:=</span> <span class=nx>clientSet</span><span class=p>.</span><span class=nf>CoreV1</span><span class=p>().</span><span class=nf>Pods</span><span class=p>(</span><span class=nx>apiv1</span><span class=p>.</span><span class=nx>NamespaceDefault</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>list</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>podClient</span><span class=p>.</span><span class=nf>List</span><span class=p>(</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>ListOptions</span><span class=p>{</span><span class=nx>limit</span><span class=p>:</span><span class=mi>500</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯¹ Pod èµ„æºå¯¹è±¡æ‰§è¡Œ List æ“ä½œå®é™…ä¸Šæ˜¯å¯¹ RESTClient è¿›è¡Œäº†å°è£…ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// file: staging/src/k8s.io/client-go/kubernetes/typed/core/v1/pod.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>pods</span><span class=p>)</span> <span class=nf>List</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>opts</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ListOptions</span><span class=p>)</span> <span class=p>(</span><span class=nx>result</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>PodList</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=nx>result</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>v1</span><span class=p>.</span><span class=nx>PodList</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>Get</span><span class=p>().</span>
</span></span><span class=line><span class=cl>		<span class=nf>Namespace</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>ns</span><span class=p>).</span>
</span></span><span class=line><span class=cl>		<span class=nf>Resource</span><span class=p>(</span><span class=s>&#34;pods&#34;</span><span class=p>).</span>
</span></span><span class=line><span class=cl>		<span class=nf>VersionedParams</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>opts</span><span class=p>,</span> <span class=nx>scheme</span><span class=p>.</span><span class=nx>ParameterCodec</span><span class=p>).</span>
</span></span><span class=line><span class=cl>		<span class=nf>Timeout</span><span class=p>(</span><span class=nx>timeout</span><span class=p>).</span>
</span></span><span class=line><span class=cl>		<span class=nf>Do</span><span class=p>(</span><span class=nx>ctx</span><span class=p>).</span>
</span></span><span class=line><span class=cl>		<span class=nf>Into</span><span class=p>(</span><span class=nx>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=dynamicclient-å®¢æˆ·ç«¯>DynamicClient å®¢æˆ·ç«¯</h4><p>DynamicClient å’Œ ClientSet ç±»ä¼¼ï¼Œä¹Ÿæ˜¯å¯¹ RESTClient çš„å°è£…ï¼Œä¸è¿‡å®ƒä¸ä»…å¯ä»¥å¯¹ Kubernetes å†…ç½®èµ„æºæ“ä½œï¼Œè¿˜èƒ½å¯¹ CRD æ“ä½œã€‚</p><p>è¿™æ˜¯å› ä¸ºï¼ŒClientSet éœ€è¦é¢„å…ˆå®ç°æ¯ç§ Resource å’Œ Version çš„æ“ä½œï¼Œå…¶å†…éƒ¨çš„æ•°æ®éƒ½æ˜¯ç»“æ„åŒ–æ•°æ®ã€‚è€Œ DynamicClient å†…éƒ¨å®ç°äº† Unstructuredï¼Œè¿™ä½¿å®ƒèƒ½å¤Ÿå¤„ç†ç”¨æˆ·è‡ªå®šä¹‰èµ„æºï¼ˆæ— æ³•æå‰é¢„çŸ¥æ•°æ®ç»“æ„ï¼‰ã€‚</p><blockquote><p>DynamicClient ä¸æ˜¯ç±»å‹å®‰å…¨çš„ï¼Œå› æ­¤åœ¨è®¿é—® CRD è‡ªå®šä¹‰èµ„æºæ—¶éœ€è¦ç‰¹åˆ«æ³¨æ„ã€‚ä¾‹å¦‚ï¼Œåœ¨æ“ä½œæŒ‡é’ˆä¸å½“çš„æƒ…å†µä¸‹ä¼šå¯¼è‡´ç¨‹åºå´©æºƒã€‚</p></blockquote><p>ClientSet ç”¨äºæ“ä½œ Kubernetes ä¸­çš„å†…å»ºèµ„æºã€‚è¿™äº›å†…å»ºèµ„æºéƒ½æœ‰ä¸¥æ ¼çš„ API è§„èŒƒï¼ŒåŒ…æ‹¬æ¯ä¸ªèµ„æºçš„å­—æ®µç±»å‹å’Œç»“æ„ï¼Œåœ¨ä½¿ç”¨ clientset æ—¶ï¼Œå¼€å‘äººå‘˜åªèƒ½æ“ä½œè¿™äº›å·²çŸ¥çš„èµ„æºï¼Œå¹¶ä¸”è¿™äº›èµ„æºçš„ç»“æ„åœ¨ç¼–è¯‘æ—¶å°±å·²ç»ç¡®å®šäº†ã€‚å› æ­¤ä¸å¤ªå¯èƒ½å‡ºç°ç±»å‹ä¸åŒ¹é…çš„é—®é¢˜ã€‚è€Œå¯¹äºå¯ä»¥æ“ä½œè‡ªå®šä¹‰èµ„æºçš„ DynamicClientï¼Œåˆ™ä¸ä¸€å®šï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// å»ºç«‹åˆ° Kubernetes é›†ç¾¤çš„è¿æ¥
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>config</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rest</span><span class=p>.</span><span class=nf>InClusterConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// å¤„ç†é”™è¯¯
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>,</span> <span class=s>&#34;Failed to get in-cluster config: %v\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// åˆ›å»ºä¸€ä¸ª DynamicClient
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>dynamicClient</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>dynamic</span><span class=p>.</span><span class=nf>NewForConfig</span><span class=p>(</span><span class=nx>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// å¤„ç†é”™è¯¯
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>,</span> <span class=s>&#34;Failed to create DynamicClient: %v\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// å®šä¹‰è‡ªå®šä¹‰èµ„æºå¯¹è±¡çš„ GVKï¼ˆGroup-Version-Kindï¼‰
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>gvk</span> <span class=o>:=</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupVersionKind</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Group</span><span class=p>:</span>   <span class=s>&#34;example.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Version</span><span class=p>:</span> <span class=s>&#34;v1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Kind</span><span class=p>:</span>    <span class=s>&#34;CustomResource&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰èµ„æºå¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>resource</span> <span class=o>:=</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupVersionResource</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Group</span><span class=p>:</span>    <span class=s>&#34;example.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Version</span><span class=p>:</span>  <span class=s>&#34;v1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Resource</span><span class=p>:</span> <span class=s>&#34;customresources&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// åˆ›å»ºä¸€ä¸ªé”™è¯¯çš„ CustomResource å®ä¾‹ï¼Œæ²¡æœ‰è®¾ç½® spec å­—æ®µ
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>obj</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;apiVersion&#34;</span><span class=p>:</span> <span class=s>&#34;example.com/v1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;kind&#34;</span><span class=p>:</span>       <span class=s>&#34;CustomResource&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;metadata&#34;</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;name&#34;</span><span class=p>:</span> <span class=s>&#34;example-cr&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;status&#34;</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;field&#34;</span><span class=p>:</span> <span class=s>&#34;value&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// åœ¨å¯¹è±¡ä¸Šè°ƒç”¨ Create æ–¹æ³•ï¼Œè¿™å¯èƒ½å¯¼è‡´ç±»å‹ä¸å®‰å…¨è€Œå´©æºƒ
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>dynamicClient</span><span class=p>.</span><span class=nf>Resource</span><span class=p>(</span><span class=nx>resource</span><span class=p>).</span><span class=nf>Namespace</span><span class=p>(</span><span class=s>&#34;default&#34;</span><span class=p>).</span><span class=nf>Create</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=nx>obj</span><span class=p>,</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>CreateOptions</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// å¤„ç†é”™è¯¯
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>,</span> <span class=s>&#34;Failed to create custom resource: %v\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>DynamicClient çš„å¤„ç†è¿‡ç¨‹å°† Resourceï¼ˆå¦‚ PodListï¼‰è½¬æ¢æˆ Unstructured ç»“æ„ç±»å‹ï¼Œå¤„ç†å®Œæˆåï¼Œå†å°† unstructured è½¬æ¢æˆ PodListã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>dynamicClient</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>dynamic</span><span class=p>.</span><span class=nf>NewForConfig</span><span class=p>(</span><span class=nx>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>gvr</span> <span class=o>:=</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupVersionResource</span><span class=p>{</span><span class=nx>Version</span><span class=p>:</span> <span class=s>&#34;v1&#34;</span><span class=p>,</span> <span class=nx>Resource</span><span class=p>:</span> <span class=s>&#34;pods&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>unstructObj</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>dynamicClient</span><span class=p>.</span><span class=nf>Resource</span><span class=p>(</span><span class=nx>gvr</span><span class=p>).</span>    <span class=c1>// è®¾ç½®èµ„æºç»„ã€èµ„æºç‰ˆæœ¬ã€èµ„æºåç§°
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>Namespace</span><span class=p>(</span><span class=nx>apiv1</span><span class=p>.</span><span class=nx>NamespaceDefault</span><span class=p>).</span>
</span></span><span class=line><span class=cl>        <span class=nf>List</span><span class=p>(</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>ListOptions</span><span class=p>{</span><span class=nx>limit</span><span class=p>:</span> <span class=mi>500</span><span class=p>})</span>    <span class=c1>// å¾—åˆ°çš„ Pod åˆ—è¡¨ä¸º unstructured.UnstructuredList æŒ‡é’ˆç±»å‹
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>podList</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>PodList</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>DefaultUnstructuredConvert</span><span class=p>.</span><span class=nf>FromUnstructured</span><span class=p>(</span><span class=nx>unstructObj</span><span class=p>.</span><span class=nf>UnstructuredContent</span><span class=p>(),</span> <span class=nx>podList</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=discoveryclient-å®¢æˆ·ç«¯>DiscoveryClient å®¢æˆ·ç«¯</h4><p>DiscoveryClient æ˜¯å‘ç°å®¢æˆ·ç«¯ï¼Œå®ƒä¸»è¦ç”¨äºå‘ç° Kubernetes API Server æ‰€æ”¯æŒçš„èµ„æºç»„ã€èµ„æºç‰ˆæœ¬ã€èµ„æºä¿¡æ¯ã€‚Kubernetes API Server æ”¯æŒå¾ˆå¤šèµ„æºç»„ã€èµ„æºç‰ˆæœ¬ã€èµ„æºä¿¡æ¯ï¼Œå¼€å‘è€…åœ¨å¼€å‘è¿‡ç¨‹ä¸­å¾ˆéš¾è®°ä½æ‰€æœ‰ä¿¡æ¯ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡ DiscoveryClient æŸ¥çœ‹æ‰€æ”¯æŒçš„èµ„æºç»„ã€èµ„æºç‰ˆæœ¬ã€èµ„æºä¿¡æ¯ã€‚</p><p>DiscoveryClient é™¤äº†å¯ä»¥å‘ç° Kubernetes API Server æ‰€æ”¯æŒçš„èµ„æºç»„ã€èµ„æºç‰ˆæœ¬ã€èµ„æºä¿¡æ¯ï¼Œè¿˜å¯ä»¥å°†è¿™äº›ä¿¡æ¯å­˜å‚¨åˆ°æœ¬åœ°ï¼Œç”¨äºæœ¬åœ°ç¼“å­˜ï¼ˆCacheï¼‰ï¼Œä»¥å‡è½»å¯¹ Kubernetes API Server è®¿é—®çš„å‹åŠ›ã€‚</p><h3 id=informer-æœºåˆ¶>Informer æœºåˆ¶</h3><p>Kubernetes å„ä¸ªç»„ä»¶éƒ½æ˜¯é€šè¿‡ REST APIè·ŸAPI Server äº¤äº’é€šä¿¡çš„ï¼Œè€Œå¦‚æœæ¯æ¬¡æ¯ä¸€ä¸ªç»„ä»¶éƒ½ç›´æ¥è·Ÿ API Server äº¤äº’å»è¯»å–/å†™å…¥åˆ°åç«¯çš„ etcd çš„è¯ï¼Œä¼šå¯¹ API Server ä»¥åŠ etcd é€ æˆéå¸¸å¤§çš„è´Ÿæ‹…ã€‚è€Œ Informer æœºåˆ¶æ˜¯ä¸ºäº†ä¿è¯å„ä¸ªç»„ä»¶ä¹‹é—´é€šä¿¡çš„å®æ—¶æ€§ã€å¯é æ€§ï¼Œå¹¶ä¸”å‡ç¼“å¯¹ API Serverå’Œetcd çš„è´Ÿæ‹…ã€‚</p><h4 id=informer-æœºåˆ¶æ¶æ„è®¾è®¡>Informer æœºåˆ¶æ¶æ„è®¾è®¡</h4><p><img src=/images/informer%e6%9e%b6%e6%9e%84.png loading=lazy></p><p>æ¯ä¸€ä¸ª Kubernetes èµ„æºä¸Šéƒ½å®ç°äº† Informer æœºåˆ¶ã€‚æ¯ä¸€ä¸ª Informer ä¸Šéƒ½ä¼šå®ç° <code>Informer</code> å’Œ <code>Lister</code> æ–¹æ³•ï¼Œå®šä¹‰ä¸åŒèµ„æºçš„ Informer å¯ä»¥ç›‘æ§ä¸åŒèµ„æºçš„èµ„æºäº‹ä»¶ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>podInformer</span> <span class=o>:=</span> <span class=nx>sharedInformer</span><span class=p>.</span><span class=nf>Core</span><span class=p>().</span><span class=nf>V1</span><span class=p>().</span><span class=nf>Pods</span><span class=p>().</span><span class=nf>Informer</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>nodeInformer</span> <span class=o>:=</span> <span class=nx>sharedInformer</span><span class=p>.</span><span class=nf>Node</span><span class=p>().</span><span class=nf>V1beta1</span><span class=p>().</span><span class=nf>RuntimeClasses</span><span class=p>().</span><span class=nf>Informer</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>Informer ä¹Ÿç§°ä½œ Shared Informerï¼Œå®ƒæ˜¯å¯ä»¥å…±äº«ä½¿ç”¨çš„ã€‚å¦‚æœåŒä¸€èµ„æºçš„ informer è¢«å¤šæ¬¡å®ä¾‹åŒ–ï¼Œä¸”æ¯ä¸ª Informer éƒ½è¯»ç‹¬ç«‹ä½¿ç”¨ä¸€ä¸ª Reflectorï¼Œé‚£ä¹ˆä¼šè¿è¡Œè¿‡å¤šç›¸åŒçš„ ListAndWatchï¼Œå¯¼è‡´ API Server <strong>è´Ÿè½½è¿‡é‡</strong>ã€‚</p><p>Shared Informer å¯ä»¥ä½¿<strong>åŒä¸€ç±»èµ„æº Informer å…±äº«ä¸€ä¸ª Reflector</strong>ï¼Œè¿™æ ·å¯ä»¥èŠ‚çº¦å¾ˆå¤šèµ„æºã€‚<strong>é€šè¿‡ map æ•°æ®ç»“æ„å®ç°å…±äº«çš„ Informer æœºåˆ¶</strong>ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>sharedInformerFactory</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>informers</span> <span class=kd>map</span><span class=p>[</span><span class=nx>reflect</span><span class=p>.</span><span class=nx>Type</span><span class=p>]</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>SharedIndexInformer</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>InformerFor</code> å‡½æ•°å¯ä»¥æ·»åŠ ä¸åŒèµ„æºçš„ Informerï¼Œå¦‚æœå·²ç»å­˜åœ¨åŒç±»å‹çš„èµ„æº Informerï¼Œåˆ™è¿”å›å½“å‰ Informerã€‚</p><h4 id=reflector>Reflector</h4><p><img src=/images/informer%e6%9e%b6%e6%9e%84.png loading=lazy></p><p>Reflector è´Ÿè´£ä¸ apiserver å»ºç«‹è¿æ¥ï¼Œä½¿ç”¨ <code>ListAndWatch</code> çš„æ–¹æ³•è·å–èµ„æºå¯¹è±¡çš„å¢é‡æ›´æ–°ã€‚</p><p>Reflector æºç å®ç°ä¸­æœ€ä¸»è¦çš„æ˜¯ <code>ListerAndWatch</code> å‡½æ•°ï¼Œå®ƒå¯ä»¥åˆ†æˆä¸¤éƒ¨åˆ†ï¼š<strong>è·å–èµ„æºåˆ—è¡¨æ•°æ®</strong>å’Œ<strong>ç›‘æ§èµ„æºå¯¹è±¡</strong>ã€‚</p><p><strong>1. è·å–èµ„æºåˆ—è¡¨æ•°æ®</strong></p><p>List æµç¨‹ï¼š</p><p><img src=/images/List%e6%b5%81%e7%a8%8b.png loading=lazy></p><ul><li>é¦–æ¬¡è¿æ¥æ—¶ä¼šå…ˆä» apiserver ä¸­ list è¯¥èµ„æºçš„æ‰€æœ‰å®ä¾‹ï¼Œ<code>list</code> ä¼šæ‹¿åˆ°è¯¥å¯¹è±¡æœ€æ–°çš„ resourceVersionï¼Œç„¶åä½¿ç”¨ <code>watch</code> æ–¹æ³•ç›‘å¬è¯¥ resourceVersion ä¹‹åçš„æ‰€æœ‰å˜åŒ–</li></ul><p><strong>2. ç›‘æ§èµ„æºå¯¹è±¡</strong></p><ul><li>è‹¥ç›‘å¬ä¸­é€”å‡ºç°å¼‚å¸¸ï¼ŒReflector åœ¨é‡è¿æ—¶ä¼šæºå¸¦ä¸Šä¸ªç‰ˆæœ¬çš„ rsourceVersionï¼Œå¹¶ä»è¯¥ resourceVersion å¢é‡æ›´æ–°ï¼Œé¿å…å†æ¬¡å…¨é‡ Listã€‚</li><li>ä¸€æ—¦è¯¥å¯¹è±¡çš„å®ä¾‹æœ‰ Addã€Deleteã€Update åŠ¨ä½œï¼ŒReflector éƒ½ä¼šæ”¶åˆ° â€œäº‹ä»¶é€šçŸ¥â€ï¼Œè¿™æ—¶ï¼Œè¯¥äº‹ä»¶ä¸å¯¹åº”çš„ API å¯¹è±¡è¿™ä¸ªç»„åˆï¼Œè¢«ç§°ä¸º<strong>å¢é‡ï¼ˆDeltaï¼‰</strong>ï¼Œå®ƒä¼šè¢«æ”¾è¿› DeltaFIFO ä¸­ã€‚</li></ul><h4 id=deltafifo>DeltaFIFO</h4><p><strong>DeltaFIFOè´Ÿè´£ç®¡ç†èµ„æºå¯¹è±¡çš„å¢é‡å˜åŒ–é€šçŸ¥å’Œæä¾›å¢é‡åŒæ­¥çš„åŠŸèƒ½ã€‚</strong></p><p>DeltaFIFO å¯ä»¥åˆ†å¼€ç†è§£ï¼š</p><ol><li>FIFO æ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ã€‚</li><li>Delta æ˜¯ä¸€ä¸ªèµ„æºå¯¹è±¡å­˜å‚¨ï¼Œå¯ä»¥ä¿å­˜èµ„æºå¯¹è±¡çš„æ“ä½œç±»å‹ã€‚</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>DeltaFIFO</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>items</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span> <span class=nx>Deltas</span>
</span></span><span class=line><span class=cl>    <span class=nx>queue</span> <span class=p>[]</span><span class=kt>string</span>  <span class=c1>// å­˜å‚¨èµ„æºå¯¹è±¡çš„ keyï¼Œé€šè¿‡ `KeyOf` å‡½æ•°è®¡ç®—å¾—åˆ°
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Deltas</span> <span class=p>[]</span><span class=nx>Delta</span>
</span></span></code></pre></td></tr></table></div></div><p>DeltaFIFO ä¸å…¶ä»–é˜Ÿåˆ—æœ€å¤§çš„ä¸åŒä¹‹å¤„æ˜¯ï¼Œ<strong>å®ƒä¼šä¿ç•™æ‰€æœ‰å…³äºèµ„æºå¯¹è±¡ï¼ˆobjï¼‰çš„æ“ä½œç±»å‹</strong>ï¼Œé˜Ÿåˆ—ä¸­ä¼šå­˜åœ¨æ‹¥æœ‰ä¸åŒæ“ä½œç±»å‹çš„åŒä¸€ä¸ªèµ„æºå¯¹è±¡ï¼Œ<strong>æ¶ˆè´¹è€…åœ¨å¤„ç†è¯¥èµ„æºå¯¹è±¡æ—¶èƒ½å¤Ÿäº†è§£è¯¥èµ„æºå¯¹è±¡æ‰€å‘ç”Ÿçš„äº‹æƒ…</strong>ã€‚</p><p><img src=/images/DeltaFIFO.png loading=lazy></p><p>DeltaFIFO æœ¬è´¨ä¸Šæ˜¯ä¸ªå…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—ï¼Œæœ‰ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œç”Ÿäº§è€…æ˜¯ Reflector è°ƒç”¨çš„ <code>Add</code> æ–¹æ³•ï¼Œæ¶ˆè´¹è€…æ˜¯ Controller è°ƒç”¨çš„ <code>Pop</code> æ–¹æ³•ã€‚</p><p><strong>1. ç”Ÿäº§è€…æ–¹æ³•</strong></p><p>DeltaFIFO é˜Ÿåˆ—ä¸­çš„èµ„æºå¯¹è±¡åœ¨ Added äº‹ä»¶ã€Updated äº‹ä»¶ã€Delete äº‹ä»¶ä¸­éƒ½è°ƒç”¨äº† <a class=link href=https://github.com/kubernetes/client-go/blob/5a0a4247921dd9e72d158aaa6c1ee124aba1da80/tools/cache/delta_fifo.go#L442 target=_blank rel=noopener><code>queueActionLocked</code> å‡½æ•°</a>ï¼š</p><ul><li>é¦–å…ˆé€šè¿‡ <code>KeyOf</code> å‡½æ•°è®¡ç®—å‡ºèµ„æºå¯¹è±¡çš„ Keyã€‚</li><li>å°† actionType å’Œèµ„æºå¯¹è±¡æ„é€ æˆ Deltaï¼Œæ·»åŠ åˆ° items ä¸­ï¼Œå¹¶å»é‡ã€‚</li><li>æ›´æ–°æ„é€ åçš„ Delta å¹¶é€šè¿‡ <code>cond.Broadcast</code> é€šçŸ¥æ‰€æœ‰æ¶ˆè´¹è€…è§£é™¤é˜»å¡ã€‚</li></ul><p><strong>2. æ¶ˆè´¹è€…æ–¹æ³•</strong></p><p><code>Pop</code> æ–¹æ³•ä½œä¸ºæ¶ˆè´¹è€…æ–¹æ³•ä½¿ç”¨ï¼Œå®ƒçš„å…¥å‚ process æ˜¯ç”¨äºæ¥æ”¶å¹¶å¤„ç†å¯¹è±¡çš„å›è°ƒæ–¹æ³•ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>DeltaFIFO</span><span class=p>)</span> <span class=nf>Pop</span><span class=p>(</span><span class=nx>process</span> <span class=nx>PopProcessFunc</span><span class=p>)</span> <span class=p>(</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>f</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=nb>len</span><span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nx>queue</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>//é˜»å¡ ç›´åˆ°è°ƒç”¨äº†f.cond.Broadcast()
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>f</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>//å–å‡ºç¬¬ä¸€ä¸ªå…ƒç´ 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>id</span> <span class=o>:=</span> <span class=nx>f</span><span class=p>.</span><span class=nx>queue</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nx>f</span><span class=p>.</span><span class=nx>queue</span> <span class=p>=</span> <span class=nx>f</span><span class=p>.</span><span class=nx>queue</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=nx>item</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>f</span><span class=p>.</span><span class=nx>items</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=nb>delete</span><span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nx>items</span><span class=p>,</span> <span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>//è¿™ä¸ªprocesså¯ä»¥åœ¨controller.goä¸­çš„processLoop()æ‰¾åˆ°
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//åˆå§‹åŒ–æ˜¯åœ¨shared_informer.goçš„Run
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//æœ€ç»ˆæ‰§è¡Œåˆ°shared_informer.goçš„HandleDeltasæ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>err</span> <span class=o>:=</span> <span class=nf>process</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>//å¦‚æœå¤„ç†å‡ºé”™äº†é‡æ–°æ”¾å›é˜Ÿåˆ—ä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=nx>e</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>err</span><span class=p>.(</span><span class=nx>ErrRequeue</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>f</span><span class=p>.</span><span class=nf>addIfNotPresent</span><span class=p>(</span><span class=nx>id</span><span class=p>,</span> <span class=nx>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>err</span> <span class=p>=</span> <span class=nx>e</span><span class=p>.</span><span class=nx>Err</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>å½“é˜Ÿåˆ—ä¸­æ²¡æœ‰æ•°æ®æ—¶ï¼Œé€šè¿‡ <code>f.cond.wait</code> é˜»å¡ç­‰å¾…æ•°æ®ï¼Œç›´åˆ°æ”¶åˆ° <code>cond.Broadcast</code> æ‰è§£é™¤é˜»å¡ã€‚</li><li>å¦‚æœé˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå–é˜Ÿå¤´æ•°æ®ï¼Œå°†è¯¥å¯¹è±¡ä¼ å…¥ <code>process</code> å‡½æ•°ï¼Œç”±ä¸Šå±‚æ¶ˆè´¹è€…è¿›è¡Œå¤„ç†ã€‚è‹¥ <code>process</code> å›è°ƒå‡½æ•°å¤„ç†å‡ºé”™ï¼Œåˆ™é‡æ–°å…¥é˜Ÿã€‚</li></ul><p>æ‰€ä»¥æ•´ä½“æµç¨‹å¦‚å›¾ï¼š</p><p><img src=/images/%e7%94%9f%e4%ba%a7%e6%b6%88%e8%b4%b9.png loading=lazy alt="Alt text"></p><p>å°†å¯¹è±¡å­˜å‚¨è‡³ Indexer åï¼Œå°†èµ„æºå¯¹è±¡åˆ†å‘åˆ° SharedInformer å¯¹åº”çš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œåœ¨ Informer ä¸­æˆ‘ä»¬é€šè¿‡ <code>informer.AddEventHandler</code> æ·»åŠ äº†å¯¹èµ„æºäº‹ä»¶çš„å¤„ç†å‡½æ•°ã€‚<a class=link href=https://github.com/PyPotato/client-go-demo/blob/master/informerDemo/main.go target=_blank rel=noopener>å¯ä»¥çœ‹ä¸ªä¾‹å­</a></p><p><strong>3. Resync æœºåˆ¶</strong></p><p><strong>ä¸ºä»€ä¹ˆéœ€è¦ Resyncï¼Ÿ</strong></p><p>é¦–å…ˆå›é¡¾ Informer çš„æ¶æ„å›¾ï¼Œä¸€å…±æœ‰ä¸‰æ–¹éœ€è¦åŒæ­¥æ•°æ®</p><p><img src=/images/informer%e6%9e%b6%e6%9e%84.png loading=lazy></p><ul><li>é¦–å…ˆæ˜¯ <strong>apiserver</strong> ä¸ <strong>Informer</strong> ä¹‹é—´é€šè¿‡ resourceVersion ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚</li><li>ç„¶åæ˜¯ <strong>Informer</strong> å’Œ <strong>controller</strong> ä¹‹é—´ï¼šåç¨‹å°† FIFO é˜Ÿåˆ—ä¸­çš„äº‹ä»¶å–å‡ºæ›´æ–°è‡³ Indexer åï¼Œè¿˜ä¼šå°†äº‹ä»¶åŒæ­¥å›è°ƒè‡³ custom controllerï¼ŒåŠ å…¥åˆ° workqueue é˜Ÿåˆ—ä¸­ã€‚</li></ul><p><strong>ä½†æ˜¯åœ¨å¤„ç† Informer äº‹ä»¶å›è°ƒæ—¶ï¼Œå¹¶ä¸å…³å¿ƒå…¶è¿”å›çš„ç»“æœ</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Informer çš„ Pop æ–¹æ³•çš„å›è°ƒå‡½æ•°æœ€åä¼šè°ƒç”¨åˆ°è¿™ä¸ªå‡½æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>processDeltas</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Object which receives event notifications from the given deltas
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>handler</span> <span class=nx>ResourceEventHandler</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>clientState</span> <span class=nx>Store</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>deltas</span> <span class=nx>Deltas</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>isInInitialList</span> <span class=kt>bool</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// from oldest to newest
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>d</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>deltas</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>obj</span> <span class=o>:=</span> <span class=nx>d</span><span class=p>.</span><span class=nx>Object</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>switch</span> <span class=nx>d</span><span class=p>.</span><span class=nx>Type</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nx>Sync</span><span class=p>,</span> <span class=nx>Replaced</span><span class=p>,</span> <span class=nx>Added</span><span class=p>,</span> <span class=nx>Updated</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1>//æŸ¥ä¸€ä¸‹æ˜¯å¦åœ¨Indexerç¼“å­˜ä¸­ å¦‚æœåœ¨ç¼“å­˜ä¸­å°±æ›´æ–°ç¼“å­˜ä¸­çš„å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=nx>old</span><span class=p>,</span> <span class=nx>exists</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>clientState</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>obj</span><span class=p>);</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>exists</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>clientState</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>obj</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=nx>handler</span><span class=p>.</span><span class=nf>OnUpdate</span><span class=p>(</span><span class=nx>old</span><span class=p>,</span> <span class=nx>obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>//æ²¡æœ‰åœ¨Indexerç¼“å­˜ä¸­ æŠŠå¯¹è±¡æ’å…¥åˆ°ç¼“å­˜ä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>clientState</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>obj</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=nx>handler</span><span class=p>.</span><span class=nf>OnAdd</span><span class=p>(</span><span class=nx>obj</span><span class=p>,</span> <span class=nx>isInInitialList</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å½“å‡ºç°å¤„ç†å¤±è´¥çš„æƒ…å†µæ—¶ï¼Œ<strong>å®šæ—¶çš„ Resync è®©è¿™äº›å¤„ç†å¤±è´¥çš„äº‹ä»¶æœ‰äº†é‡æ–° onUpdate å¤„ç†çš„æœºä¼š</strong></p><p><strong>Resync åšäº†ä»€ä¹ˆï¼Ÿ</strong></p><p>Resync çš„é€»è¾‘éå¸¸ç®€å•ï¼Œå°±æ˜¯å®šæ—¶å°†æœ¬åœ°ç¼“å­˜ï¼ˆIndexerï¼‰ä¸­æ‰€æœ‰çš„èµ„æºå¯¹è±¡é‡æ–°æ¨é€åˆ° DeltaFIFO ä¸­ï¼Œå¹¶è®¾å®šæ“ä½œç±»å‹ä¸º Syncã€‚</p><p><strong>4. SharedInformer æ¶ˆè´¹ Deltas</strong></p><p>ä¸»è¦çœ‹å›è°ƒå‡½æ•° <code>processDeltas</code>ï¼ˆè§ğŸ‘†ï¼‰</p><h4 id=indexer>Indexer</h4><p><strong>Indexer è´Ÿè´£å­˜å‚¨èµ„æºå¯¹è±¡çš„å®Œæ•´å‰¯æœ¬å’Œæä¾›æŸ¥è¯¢åŠŸèƒ½</strong>ï¼Œç”¨äºå‡è½» API Server å’Œ Etcd çš„å‹åŠ›ã€‚</p><p>Indexer æ˜¯åœ¨ ThreadSafeMap çš„åŸºç¡€ä¸Šè¿›è¡Œäº†å°è£…ï¼Œå®ƒç»§æ‰¿äº† ThreadSafeMap çš„ç›¸å…³æ–¹æ³•ï¼Œå¹¶å®ç°äº† Indexer Func ç­‰åŠŸèƒ½ â€”â€” æä¾›äº†ç´¢å¼•åŠŸèƒ½ã€‚</p><p><img src=/images/Indexer%e5%ad%98%e5%82%a8%e7%bb%93%e6%9e%84.png loading=lazy></p><p><strong>1. ThreadSafeMap å¹¶å‘å®‰å…¨å­˜å‚¨</strong></p><p>TreadSafeMap ç»“æ„å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>threadSafeMap</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>item</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span> <span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>item çš„ key é€šè¿‡ keyFunc å‡½æ•°è®¡ç®—ï¼Œé»˜è®¤ä½¿ç”¨ <code>MetaNamespaceKeyFunc</code> å‡½æ•°è®¡ç®—å‡º <code>&lt;namespace>/&lt;name></code> æ ¼å¼çš„ keyï¼Œvalue ç”¨äºå­˜å‚¨èµ„æºå¯¹è±¡ã€‚</p><p><strong>2. Indexer ç´¢å¼•å™¨</strong></p><p>Indexer å¯ä»¥<strong>è‡ªå®šä¹‰ç´¢å¼•å‡½æ•°</strong>ï¼Œå®ƒæœ‰ 4 ä¸ªé‡è¦æ•°æ®ç»“æ„ï¼šIndicesã€Indexã€Indexers å’Œ IndexFuncã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Indexers</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>IndexFunc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>IndexFunc</span> <span class=kd>func</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>([]</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>indices</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>Index</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>index</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>sets</span><span class=p>.</span><span class=nx>String</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><strong>Indexers</strong>ï¼šå­˜å‚¨ç´¢å¼•å™¨ï¼Œkey ä¸ºç´¢å¼•å™¨åç§°ï¼Œvalue ä¸ºç´¢å¼•å™¨çš„å®ç°å‡½æ•°ã€‚</li><li><strong>IndexFunc</strong>ï¼šç´¢å¼•å™¨å‡½æ•°ï¼Œå®šä¹‰ä¸ºæ¥æ”¶ä¸€ä¸ªèµ„æºå¯¹è±¡ï¼Œè¿”å›æ£€ç´¢ç»“æœåˆ—è¡¨ã€‚</li><li><strong>Indices</strong>ï¼šå­˜å‚¨ç¼“å­˜å™¨ï¼Œkey ä¸ºç¼“å­˜å™¨åç§°ï¼Œvalue ä¸ºç¼“å­˜æ•°æ®ã€‚</li><li><strong>Index</strong>ï¼šå­˜å‚¨ç¼“å­˜æ•°æ®ï¼Œå…¶ç»“æ„ä¸º K/Vã€‚</li></ul><p>å¯ä»¥å…ˆæ¥çœ‹ä¸€ä¸ªè‡ªå®šä¹‰ç´¢å¼•çš„ä¾‹å­ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl><span class=c1>// å¯¼å…¥åŒ…
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;strings&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>metav1</span> <span class=s>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;k8s.io/client-go/tools/cache&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºæ ¹æ® Pod å¯¹è±¡çš„ annotations å­—æ®µä¸­çš„ users å±æ€§ï¼Œç”Ÿæˆä¸€ä¸ªåŒ…å«æ‰€æœ‰ç”¨æˆ·åçš„å­—ç¬¦ä¸²åˆ‡ç‰‡
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>UsersIndexFunc</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>([]</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è·å– Pod å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>pod</span> <span class=o>:=</span> <span class=nx>obj</span><span class=p>.(</span><span class=o>*</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// è·å– users å±æ€§
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>usersString</span> <span class=o>:=</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Annotations</span><span class=p>[</span><span class=s>&#34;users&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// å°† users å±æ€§åˆ†å‰²ä¸ºå­—ç¬¦ä¸²åˆ‡ç‰‡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Split</span><span class=p>(</span><span class=nx>usersString</span><span class=p>,</span> <span class=s>&#34;,&#34;</span><span class=p>),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ä¸»å‡½æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ ¹æ® UsersIndexFunc å»ºç«‹ç›¸åº”çš„ç´¢å¼•ç»“æ„
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>index</span> <span class=o>:=</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>NewIndexer</span><span class=p>(</span><span class=nx>cache</span><span class=p>.</span><span class=nx>MetaNamespaceKeyFunc</span><span class=p>,</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>Indexers</span><span class=p>{</span><span class=s>&#34;byUser&#34;</span><span class=p>:</span> <span class=nx>UsersIndexFunc</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// åˆ›å»ºä¸‰ä¸ª Pod å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>pod1</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>{</span><span class=nx>ObjectMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;one&#34;</span><span class=p>,</span> <span class=nx>Annotations</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;users&#34;</span><span class=p>:</span> <span class=s>&#34;ernie,bert&#34;</span><span class=p>}}}</span>
</span></span><span class=line><span class=cl>    <span class=nx>pod2</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>{</span><span class=nx>ObjectMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;two&#34;</span><span class=p>,</span> <span class=nx>Annotations</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;users&#34;</span><span class=p>:</span> <span class=s>&#34;bert,oscar&#34;</span><span class=p>}}}</span>
</span></span><span class=line><span class=cl>    <span class=nx>pod3</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>{</span><span class=nx>ObjectMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;tre&#34;</span><span class=p>,</span> <span class=nx>Annotations</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;users&#34;</span><span class=p>:</span> <span class=s>&#34;ernie,elmo&#34;</span><span class=p>}}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// å°† Pod å¯¹è±¡æ·»åŠ åˆ° cache.Indexer å¯¹è±¡ä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>index</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>pod1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>index</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>pod2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>index</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>pod3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ä»åˆšåˆšæ„å»ºçš„ç´¢å¼•ç»“æ„ä¸­ï¼Œè·å–æ‰€æœ‰åŒ…å«ç”¨æˆ·åä¸º &#34;ernie&#34; çš„ Pod å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>erniePods</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>index</span><span class=p>.</span><span class=nf>ByIndex</span><span class=p>(</span><span class=s>&#34;byUser&#34;</span><span class=p>,</span> <span class=s>&#34;ernie&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// éå†æ‰€æœ‰åŒ…å«ç”¨æˆ·åä¸º &#34;ernie&#34; çš„ Pod å¯¹è±¡ï¼Œå¹¶æ‰“å°å…¶åç§°
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>erniePod</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>erniePods</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>erniePod</span><span class=p>.(</span><span class=o>*</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>).</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// è¾“å‡º
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>one</span>
</span></span><span class=line><span class=cl><span class=nx>tre</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šé¢çš„ä»£ç é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªç´¢å¼•å™¨å‡½æ•° <code>UserIndexFunc</code>ï¼Œåœ¨è¯¥å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰æŸ¥è¯¢å‡ºæ‰€æœ‰ Pod èµ„æºä¸‹ Annotations å­—æ®µçš„ key ä¸º users çš„ Podã€‚</p><p>cache.NewIndexer å‡½æ•°å®ä¾‹åŒ–äº† Indexer å¯¹è±¡ï¼Œå®ƒæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šç¬¬ä¸€ä¸ªæ˜¯ KeyFuncï¼Œç”¨äºè®¡ç®—èµ„æºå¯¹è±¡çš„ keyï¼›ç¬¬äºŒä¸ªæ˜¯ cache.Indexersï¼Œç”¨äºå®šä¹‰ç´¢å¼•å™¨ï¼Œå…¶ä¸­ key ä¸ºç´¢å¼•å™¨çš„åç§°ï¼ˆbyUserï¼‰ï¼Œvalue ä¸ºç´¢å¼•å™¨ã€‚é€šè¿‡ index.Add å‡½æ•°æ·»åŠ  3 ä¸ª Pod èµ„æºå¯¹è±¡ã€‚æœ€åé€šè¿‡ index.ByIndex å‡½æ•°æŸ¥è¯¢ byUser ç´¢å¼•å™¨ä¸‹åŒ¹é… ernie å­—æ®µçš„ Pod åˆ—è¡¨ã€‚</p><p><strong>æ‰€ä»¥ Indexer ä¸­çš„ 4 ä¸ªç»“æ„ä¹‹é—´çš„ååŒå…³ç³»å¦‚ä¸‹ï¼š</strong></p><ul><li>æ ¹æ®è‡ªå®šä¹‰ç´¢å¼•å‡½æ•°å»ºç«‹ç´¢å¼•ç»“æ„</li><li>é€šè¿‡ Add æ–¹æ³•å°†èµ„æºå¯¹è±¡åŠ å…¥è¿™ä¸ªç´¢å¼•ç»“æ„</li><li>åˆ©ç”¨è¯¥ç´¢å¼•ç»“æ„æä¾›çš„ç´¢å¼•æ–¹æ³•è·å–æ»¡è¶³æ¡ä»¶çš„èµ„æºå¯¹è±¡çš„ key</li><li>ç”¨è¿™ä¸ª key åˆ°çœŸæ­£å­˜å‚¨çš„åœ°æ–¹è·å–èµ„æºå¯¹è±¡</li></ul><p><img src=/images/index%e6%b5%81%e7%a8%8b.png loading=lazy alt="Alt text"></p><p><strong>3. ç´¢å¼•å™¨æ ¸å¿ƒå®ç°</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>threadSafeMap</span><span class=p>)</span> <span class=nf>ByIndex</span><span class=p>(</span><span class=nx>indexName</span><span class=p>,</span> <span class=nx>indexKey</span> <span class=kt>string</span><span class=p>)</span> <span class=p>([]</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>indexFunc</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>indexers</span><span class=p>[</span><span class=nx>indexName</span><span class=p>]</span>  <span class=c1>// æŸ¥æ‰¾ç´¢å¼•åå¯¹åº”çš„ç´¢å¼•å‡½æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>index</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>indices</span><span class=p>[</span><span class=nx>indexName</span><span class=p>]</span>   <span class=c1>// æŸ¥æ‰¾ç´¢å¼•åå¯¹åº”çš„ç¼“å­˜å™¨
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>set</span> <span class=o>:=</span> <span class=nx>index</span><span class=p>[</span><span class=nx>indexKey</span><span class=p>]</span>  <span class=c1>// ä» index ä¸­è·å–å¯¹åº”çš„æ•°æ®
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>list</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kd>interface</span><span class=p>{},</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>set</span><span class=p>.</span><span class=nf>Len</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>key</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>set</span><span class=p>.</span><span class=nf>List</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>list</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>list</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>items</span><span class=p>[</span><span class=nx>key</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>list</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>Index ç¼“å­˜æ•°æ®ä¸ºé›†åˆï¼ˆå…ƒç´ ä¸é‡å¤ï¼‰ã€‚ç”±äº Go æ ‡å‡†åº“æ²¡æœ‰æä¾› Set æ•°æ®ç»“æ„ï¼Œè€Œ Go ä¸­ map æ˜¯ä¸èƒ½å­˜åœ¨ç›¸åŒçš„ key çš„ï¼Œå› æ­¤ Kubernetes å°† map ç»“æ„ç±»å‹çš„ key ä½œä¸º Set æ•°æ®ç»“æ„ï¼Œå®ç°å»é‡ç‰¹æ€§ã€‚</p></blockquote><h3 id=workqueue>WorkQueue</h3><p><strong>Event äº§ç”Ÿçš„é€Ÿåº¦æ¯”å¤„ç† Event çš„é€Ÿåº¦å¿«ï¼ŒWorkQueueå°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§é€Ÿåº¦ä¸ä¸€è‡´çš„é—®é¢˜è€Œå¼•å…¥çš„</strong></p><p><img src=/images/informer%e6%9e%b6%e6%9e%84.png loading=lazy alt="Alt text"></p><p>WorkQueue ç›¸æ¯”æ™®é€šçš„ FIFO ç›¸æ¯”æ”¯æŒï¼š</p><ul><li>æœ‰åºï¼šæŒ‰æ·»åŠ é¡ºåºå¤„ç†å…ƒç´ ã€‚</li><li>å»é‡ï¼šç›¸åŒå…ƒç´ åœ¨åŒä¸€æ—¶é—´ä¸ä¼šè¢«é‡å¤å¤„ç†ã€‚</li><li>å¹¶å‘æ€§ï¼šå¤šç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ã€‚</li><li>æ ‡è®°æœºåˆ¶ï¼šæ”¯æŒæ ‡è®°ï¼Œæ ‡è®°ä¸€ä¸ªå…ƒç´ æ˜¯å¦è¢«å¤„ç†ï¼Œå…è®¸å…ƒç´ åœ¨å¤„ç†æ—¶é‡æ–°æ’é˜Ÿã€‚</li><li>é€šçŸ¥æœºåˆ¶ï¼šShutDown æ–¹æ³•é€šè¿‡ä¿¡å·é‡é€šçŸ¥é˜Ÿåˆ—ä¸å†æ¥æ”¶æ–°å…ƒç´ ã€‚</li><li>å»¶è¿Ÿï¼šæ”¯æŒå»¶è¿Ÿé˜Ÿåˆ—ï¼Œå»¶è¿Ÿä¸€æ®µæ—¶é—´åå†è¿›å°†å…ƒç´ å…¥é˜Ÿã€‚</li><li>é™é€Ÿï¼šæ”¯æŒé™é€Ÿé˜Ÿåˆ—ï¼Œé™åˆ¶ä¸€ä¸ªå…ƒç´ è¢«é‡æ–°æ’é˜Ÿçš„é€Ÿç‡ã€‚</li><li>Metricï¼šæ”¯æŒ metric ç›‘æ§æŒ‡æ ‡ï¼Œç”¨äº Prometheus ç›‘æ§ã€‚</li></ul><p>WorkQueue æ”¯æŒ 3 ç§é˜Ÿåˆ—ï¼Œæä¾› 3 ç§æ¥å£ï¼š</p><ul><li><strong>Interface</strong>ï¼šFIFO é˜Ÿåˆ—æ¥å£ï¼Œæ”¯æŒå»é‡ã€‚</li><li><strong>DelayInterface</strong>ï¼šå»¶è¿Ÿé˜Ÿåˆ—æ¥å£ï¼ŒåŸºäº Interface å°è£…ã€‚</li><li><strong>RatelimitingInterface</strong>ï¼šé™é€Ÿé˜Ÿåˆ—æ¥å£ï¼ŒåŸºäº DelayInterface å°è£…ã€‚</li></ul><h4 id=fifo-é˜Ÿåˆ—>FIFO é˜Ÿåˆ—</h4><p>æ–¹æ³•è¯´æ˜ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Interface</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>Add</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span>   <span class=c1>// ç»™é˜Ÿåˆ—æ·»åŠ å…ƒç´ ï¼Œç±»å‹ä»»æ„
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>Len</span><span class=p>()</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>    <span class=nf>Get</span><span class=p>()</span> <span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>shutdown</span> <span class=kt>bool</span><span class=p>)</span>     <span class=c1>// è·å–é˜Ÿå¤´å…ƒç´ 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>Done</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span>  <span class=c1>// æ ‡è®°å…ƒç´ å·²è¢«å¤„ç†
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>ShutDown</span><span class=p>()</span>  <span class=c1>// å…³é—­é˜Ÿåˆ—
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>ShuttingDown</span><span class=p>()</span> <span class=kt>bool</span> <span class=c1>// æŸ¥è¯¢é˜Ÿåˆ—æ˜¯å¦æ­£åœ¨è¢«å…³é—­
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>FIFO æ•°æ®ç»“æ„å®šä¹‰ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Type</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>queue</span> <span class=p>[]</span><span class=nx>t</span>   <span class=c1>// å®é™…å­˜å‚¨å…ƒç´ çš„åœ°æ–¹
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>dirty</span> <span class=nx>set</span>   <span class=c1>// ä¿è¯å»é‡ï¼Œå¹¶ä¸”ä¿è¯åŒä¸€ä¸ªå…ƒç´ è¢«å¹¶å‘æ·»åŠ å¤šæ¬¡ï¼Œä¹Ÿåªä¼šè¢«å¤„ç†ä¸€æ¬¡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>processing</span> <span class=nx>set</span>  <span class=c1>// æ ‡è®°ä¸€ä¸ªå…ƒç´ æ˜¯å¦è¢«æ­£å¸¸å¤„ç†
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>cond</span> <span class=o>*</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Cond</span>
</span></span><span class=line><span class=cl>    <span class=nx>shuttingDown</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>    <span class=nx>metrics</span> <span class=nx>queueMetrics</span>
</span></span><span class=line><span class=cl>    <span class=nx>unfinishedWorkUpdatePeriod</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>    <span class=nx>clock</span> <span class=nx>clock</span><span class=p>.</span><span class=nx>Clock</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å­˜å‚¨è¿‡ç¨‹å¦‚å›¾ï¼š</p><p><img src=/images/%e5%ad%98%e5%82%a8%e8%bf%87%e7%a8%8b.png loading=lazy alt="Alt text"></p><ul><li>é€šè¿‡ Add æ–¹æ³•å¾€ FIFO ä¸­æ’å…¥ä¸‰ä¸ªå…ƒç´ ã€‚</li><li>é€šè¿‡ Get æ–¹æ³•è·å–æœ€å…ˆè¿›å…¥çš„å…ƒç´ ï¼Œæ”¾å…¥ processing é˜Ÿåˆ—ã€‚</li><li>é€šè¿‡ Done æ–¹æ³•æ ‡è®°è¯¥å…ƒç´ å·²ç»è¢«å¤„ç†å®Œæˆï¼Œå¹¶ä» processing é˜Ÿåˆ—ä¸­å‡ºé˜Ÿã€‚</li></ul><p>FIFO å¹¶å‘å­˜å‚¨è¿‡ç¨‹ï¼š</p><p><img src=/images/%e5%b9%b6%e5%8f%91%e5%ad%98%e5%82%a8%e8%bf%87%e7%a8%8b.png loading=lazy alt="Alt text"></p><ul><li>goroutine A é€šè¿‡ Get è·å–é˜Ÿåˆ— 1 å…ƒç´ ï¼Œå°†å…¶æ·»åŠ åˆ° processing é˜Ÿåˆ—ã€‚</li><li>åŒä¸€æ—¶é—´ï¼Œgoroutine B é€šè¿‡ Add æ–¹æ³•æ’å…¥å¦ä¸€ä¸ª 1 å…ƒç´ ã€‚</li><li>æ­¤æ—¶ç”±äºåœ¨ processing é˜Ÿåˆ—å·²ç»å­˜åœ¨ç›¸åŒçš„å…ƒç´ ï¼Œæ‰€ä»¥åé¢çš„ 1 å…ƒç´ ä¸ä¼šç›´æ¥æ·»åŠ åˆ° queue å­—æ®µä¸­ï¼Œè€Œæ˜¯æ·»åŠ åˆ° dirtyã€‚</li><li>å½“ goroutine A é€šè¿‡ Done æ ‡è®°å¤„ç†å®Œæˆåï¼Œå¦‚æœ dirty å­—æ®µä¸­æœ‰ 1 å…ƒç´ ï¼Œåˆ™å°†å…¶è¿½åŠ åˆ° queue å­—æ®µå°¾éƒ¨ã€‚</li></ul><h4 id=å»¶è¿Ÿé˜Ÿåˆ—>å»¶è¿Ÿé˜Ÿåˆ—</h4><p>å»¶è¿Ÿé˜Ÿåˆ—åŸºäº FIFO é˜Ÿåˆ—æ¥å£ï¼Œæ–°å¢äº† <code>AddAfter</code> æ–¹æ³•ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>DelayingInterface</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Interface</span>
</span></span><span class=line><span class=cl>    <span class=nf>AddAfter</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>duration</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>delayingType</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Interface</span>
</span></span><span class=line><span class=cl>    <span class=nx>clock</span> <span class=nx>clock</span><span class=p>.</span><span class=nx>Clock</span>
</span></span><span class=line><span class=cl>    <span class=nx>stopCh</span> <span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=nx>heartbeat</span> <span class=nx>clock</span><span class=p>.</span><span class=nx>Ticker</span>
</span></span><span class=line><span class=cl>    <span class=nx>waitingForAddCh</span> <span class=kd>chan</span> <span class=o>*</span><span class=nx>waitFor</span>   <span class=c1>// waitchan é»˜è®¤å¤§å° 1000
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>metrics</span>          <span class=nx>retryMetrics</span>
</span></span><span class=line><span class=cl>    <span class=nx>deprecatedMetrics</span> <span class=nx>retryMetrics</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>waitFor</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>data</span>    <span class=nx>t</span>          <span class=c1>// å‡†å¤‡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„æ•°æ®
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>readyAt</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>  <span class=c1>// åº”è¯¥è¢«åŠ å…¥é˜Ÿåˆ—çš„æ—¶é—´
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>index</span> <span class=kt>int</span>          <span class=c1>// åœ¨ waitForPriorityQueueï¼ˆå°é¡¶å †ï¼‰ä¸­çš„ç´¢å¼•
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…¶ä¸­æœ€ä¸»è¦çš„å­—æ®µæ˜¯ <code>waitingForAddCh</code> ï¼Œé»˜è®¤å¤§å° 1000ã€‚</p><p>å»¶è¿Ÿé˜Ÿåˆ—é€šè¿‡ <code>AddAfter</code> æ–¹æ³•æ’å…¥å…ƒç´ ï¼Œå½“æ’å…¥çš„å…ƒç´ å¤§å°å¤§äºç­‰äº 1000 æ—¶ï¼Œå»¶è¿Ÿé˜Ÿåˆ—é˜»å¡ã€‚è¿è¡ŒåŸç†ï¼š</p><p><img src=/images/%e5%bb%b6%e8%bf%9f%e9%98%9f%e5%88%97%e8%bf%90%e8%a1%8c%e5%8e%9f%e7%90%86.png loading=lazy alt="Alt text"></p><blockquote><p>é€šè¿‡ AddAfter å°†å…ƒç´ åŠ å…¥ waitingForAddChï¼ŒwaitingLoop æ¥æ¶ˆè´¹å…ƒç´ ã€‚å½“å…ƒç´ çš„å»¶è¿Ÿæ—¶é—´æœªåˆ°è¾¾æ—¶ï¼Œåˆ™å°†å…ƒç´ æ”¾å…¥æŒ‰å»¶è¿Ÿæ—¶é—´æ’åºçš„ä¼˜å…ˆé˜Ÿåˆ—ï¼ˆwaitForPriorityQueueï¼‰ä¸­ã€‚å½“å…ƒç´ å»¶è¿Ÿæ—¶é—´åˆ°è¾¾æ—¶ï¼Œå°†å…ƒç´ æ’å…¥ FIFO é˜Ÿåˆ—ï¼Œå¹¶éå†ä¼˜å…ˆé˜Ÿåˆ—ï¼ŒæŒ‰ä¸Šè¿°é€»è¾‘éªŒè¯æ—¶é—´ã€‚</p></blockquote><h4 id=é™é€Ÿé˜Ÿåˆ—>é™é€Ÿé˜Ÿåˆ—</h4><p>åŸºäºå»¶è¿Ÿé˜Ÿåˆ—å’Œ FIFO é˜Ÿåˆ—æ¥å£å°è£…ï¼Œåœ¨åŸæœ‰çš„åŠŸèƒ½ä¸Šå¢åŠ äº† <code>AddRateLimited</code>ã€<code>Forget</code>ã€<code>NumRequeues</code> æ–¹æ³•ã€‚</p><p>é™é€Ÿé˜Ÿåˆ—çš„é‡ç‚¹åœ¨äºå®ƒæä¾›çš„ 4 ç§é™é€Ÿç®—æ³•æ¥å£ï¼ˆRateLimiterï¼‰ã€‚å®ƒçš„åŸç†æ˜¯<strong>åˆ©ç”¨å»¶è¿Ÿé˜Ÿåˆ—çš„ç‰¹æ€§ï¼Œå»¶è¿ŸæŸä¸ªå…ƒç´ çš„æ’å…¥æ—¶é—´ï¼Œè¾¾åˆ°é™é€Ÿç›®çš„</strong>ã€‚</p><p>é™é€Ÿé˜Ÿåˆ—æ¥å£æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>RateLimiter</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>When</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>    <span class=c1>// è·å–æŒ‡å®šå…ƒç´ åº”è¯¥ç­‰å¾…çš„æ—¶é—´
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>Forget</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span>    <span class=c1>// é‡Šæ”¾æŒ‡å®šå…ƒç´ ï¼Œæ¸…ç©ºè¯¥å…ƒç´ çš„æ’é˜Ÿæ•°
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>NumRequeues</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>int</span>   <span class=c1>// è·å–æŒ‡å®šå…ƒç´ çš„æ’é˜Ÿæ•°
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>å¼•å…¥ä¸€ä¸ªæ¦‚å¿µ â€”â€” <strong>é™é€Ÿå‘¨æœŸ</strong>ï¼šä»æ‰§è¡Œ <code>AddRateLimited</code> æ–¹æ³•åˆ°æ‰§è¡Œå®Œ <code>Forget</code> æ–¹æ³•ä¹‹é—´çš„æ—¶é—´ã€‚</p></blockquote><p><strong>1. ä»¤ç‰Œæ¡¶ç®—æ³•</strong></p><p><img src=/images/%e4%bb%a4%e7%89%8c%e6%a1%b6%e7%ae%97%e6%b3%95.png loading=lazy alt="Alt text"></p><p>é€šè¿‡ Go ä¸‰æ–¹åº“ <code>golang.org/x/time/rate</code> å®ç°ã€‚ä»¤ç‰Œæ¡¶ç®—æ³•å†…éƒ¨å®ç°äº†ä¸€ä¸ªå­˜æ”¾ token çš„æ¡¶ï¼Œåˆå§‹æ¡¶ä¸ºç©ºï¼Œtoken ä¼šä»¥å›ºå®šé€Ÿç‡å¾€æ¡¶é‡Œå¡«å……ï¼Œç›´åˆ°å¡«æ»¡ï¼Œå¤šä½™çš„ token
ä¼šè¢«ä¸¢å¼ƒã€‚æ¯ä¸ªå…ƒç´ éƒ½ä¼šä»ä»¤ç‰Œæ¡¶ä¸­å¾—åˆ°ä¸€ä¸ª tokenï¼Œåªæœ‰å¾—åˆ° token çš„å…ƒç´ æ‰èƒ½è¢« acceptï¼Œå¦åˆ™å¤„äºç­‰å¾…çŠ¶æ€ã€‚<strong>å³é€šè¿‡æ§åˆ¶å‘æ”¾ token çš„é€Ÿç‡è¾¾åˆ°é™é€Ÿç›®çš„</strong>ã€‚</p><p><strong>2. æ’é˜ŸæŒ‡æ•°ç®—æ³•</strong></p><p>æ’é˜ŸæŒ‡æ•°ç®—æ³•å°†ç›¸åŒå…ƒç´ çš„æ’é˜Ÿæ•°ä½œä¸ºæŒ‡æ•°ï¼Œæ’é˜Ÿæ•°å¢å¤§ï¼Œé€Ÿç‡é™åˆ¶å‘ˆæŒ‡æ•°çº§å¢é•¿ï¼Œä½†å…¶æœ€å¤§ä¸ä¼šè¶…è¿‡ <code>maxDelay</code>ã€‚æ ¸å¿ƒå®ç°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>exp</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>[</span><span class=nx>item</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>[</span><span class=nx>item</span><span class=p>]</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>[</span><span class=nx>item</span><span class=p>]</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=nx>backoff</span> <span class=o>:=</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>baseDelay</span><span class=p>.</span><span class=nf>Nanoseconds</span><span class=p>())</span> <span class=o>*</span> <span class=nx>math</span><span class=p>.</span><span class=nf>Pow</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>exp</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>backoff</span> <span class=p>&gt;</span> <span class=nx>math</span><span class=p>.</span><span class=nx>MaxInt64</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>r</span><span class=p>.</span><span class=nx>maxDelay</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…¶ä¸­ï¼Œ<code>failures</code> ç”¨äºç»Ÿè®¡å…ƒç´ æ’é˜Ÿæ•°ï¼Œæ¯å½“ <code>AddRateLimited</code> æ’å…¥æ–°å…ƒç´ ï¼Œè¯¥å­—æ®µåŠ  1ï¼›<code>baseDelay</code> æ˜¯æœ€åˆé™é€Ÿï¼ˆç³»æ•°ï¼Œé»˜è®¤ 5 msï¼‰ï¼Œ<code>maxDelay</code> æ˜¯æœ€å¤§é™é€Ÿå•ä½ï¼ˆé»˜è®¤ 1000 sï¼‰ã€‚
å»¶è¿Ÿæ—¶é—´çš„è®¡ç®—å…¬å¼å¯ä»¥æ€»ç»“ä¸ºï¼š$back off = baseDeley * 2^{\exp}$ï¼Œå…¶ä¸­ exp ä¸ºæ’é˜Ÿæ•°ã€‚</p><p><strong>3. è®¡æ•°å™¨ç®—æ³•</strong></p><p>é€šè¿‡ <strong>é™åˆ¶ä¸€æ®µæ—¶é—´å†…å…è®¸é€šè¿‡å…ƒç´ æ•°</strong> è¾¾åˆ°é™é€Ÿç›®çš„ã€‚æ¯æ’å…¥ä¸€ä¸ªå…ƒç´ ï¼Œè®¡æ•°å™¨åŠ  1ï¼Œå½“è®¡æ•°å™¨åˆ°è¾¾é˜ˆå€¼å¹¶ä¸”è¿˜åœ¨é™é€Ÿå‘¨æœŸå†…æ—¶ï¼Œåˆ™ä¸å…è®¸å…ƒç´ é€šè¿‡ã€‚WorkQueue åœ¨æ­¤åŸºç¡€ä¸Šæ‰©å±•äº†ä¸¤ç§å»¶è¿Ÿé€Ÿç‡ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>[</span><span class=nx>item</span><span class=p>]</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>[</span><span class=nx>item</span><span class=p>]</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>[</span><span class=nx>item</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>maxFastAttempts</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>fastDelay</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nx>slowDelay</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>4. æ··åˆæ¨¡å¼</strong></p><p>å°†å¤šç§é™é€Ÿç®—æ³•æ··åˆä½¿ç”¨ï¼Œå¦‚åŒæ—¶ä½¿ç”¨æ’é˜ŸæŒ‡æ•°ç®—æ³•å’Œä»¤ç‰Œæ¡¶ç®—æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>DefaultControllerRateLimiter</span><span class=p>()</span> <span class=nx>RateLimiter</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>NewMaxOfRateLimiter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nf>NewItemExponentialFailureRateLimiter</span><span class=p>(</span><span class=mi>5</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>,</span> <span class=mi>1000</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=o>&amp;</span><span class=nx>BucketRateLimiter</span><span class=p>{</span><span class=nx>limiter</span><span class=p>:</span> <span class=nx>rate</span><span class=p>.</span><span class=nf>NewLimiter</span><span class=p>(</span><span class=nx>rate</span><span class=p>.</span><span class=nf>Limit</span><span class=p>(</span><span class=mi>10</span><span class=p>),</span> <span class=mi>100</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=eventbroadcaster-äº‹ä»¶ç®¡ç†å™¨>EventBroadcaster äº‹ä»¶ç®¡ç†å™¨</h3><blockquote><p>è¿™é‡Œçš„ Event æ˜¯ Kubernetes æ‰€ç®¡ç†çš„ Event èµ„æºå¯¹è±¡ï¼Œè€Œé Etcd é›†ç¾¤ç›‘æ§æœºåˆ¶äº§ç”Ÿçš„å›è°ƒäº‹ä»¶ï¼Œæ³¨æ„åŒºåˆ†ã€‚</p></blockquote><p>Event ä½œä¸ºä¸€ç§é›†ç¾¤èµ„æºä¿å­˜åœ¨ Etcd ä¸­ï¼Œä¸ºäº†é¿å…ç£ç›˜ç©ºé—´è¢«å¡«æ»¡ï¼Œåªä¿ç•™æœ€è¿‘ 1 å°æ—¶çš„äº‹ä»¶ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Event æ•°æ®ç»“æ„å®šä¹‰
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Event</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>metav1</span><span class=p>.</span><span class=nx>TypeMeta</span>
</span></span><span class=line><span class=cl>    <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span>
</span></span><span class=line><span class=cl>    <span class=nx>InvolvedObject</span> <span class=nx>ObjectReference</span>
</span></span><span class=line><span class=cl>    <span class=nx>Reason</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>Message</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>Source</span> <span class=nx>EventSource</span>
</span></span><span class=line><span class=cl>    <span class=nx>FirstTimestamp</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl>    <span class=nx>LastTimestamp</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl>    <span class=nx>Count</span> <span class=kt>int32</span>
</span></span><span class=line><span class=cl>    <span class=nx>Type</span> <span class=kt>string</span> 
</span></span><span class=line><span class=cl>    <span class=nx>EventTime</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>MicroTime</span> 
</span></span><span class=line><span class=cl>    <span class=nx>Series</span> <span class=o>*</span><span class=nx>EventSeries</span> 
</span></span><span class=line><span class=cl>    <span class=nx>Action</span> <span class=kt>string</span> 
</span></span><span class=line><span class=cl>    <span class=nx>Related</span> <span class=o>*</span><span class=nx>ObjectReference</span> 
</span></span><span class=line><span class=cl>    <span class=nx>ReportingController</span> <span class=kt>string</span> 
</span></span><span class=line><span class=cl>    <span class=nx>ReportingInstance</span> <span class=kt>string</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>EventBroadcaster äº‹ä»¶ç®¡ç†æœºåˆ¶åŸç†å›¾ï¼š</p><p><img src=/images/EventBroadcaster%e5%8e%9f%e7%90%86%e5%9b%be.png loading=lazy alt="Alt text"></p><p>åœ¨å®šä½ä¸Šï¼Œå¯ä»¥æŠŠ EventBroadcaster ç†è§£æˆé›†æˆåœ¨å„ä¸ªç»„ä»¶ä¸­çš„ä¸€å¥— SDKï¼Œå®ƒå¯ä»¥ç”¨æ¥äº§ç”Ÿå’Œåˆ†å‘äº‹ä»¶ã€‚å…¶ä¸­ä¸»è¦æœ‰ä¸‰ä¸ªç»„ä»¶ï¼š</p><ul><li><strong>EventRecorder</strong>ï¼šäº‹ä»¶ç”Ÿäº§è€…ã€‚Kubernetes ç»„ä»¶é€šè¿‡ EventRecorder è®°å½•å…³é”®æ€§äº‹ä»¶ã€‚</li><li><strong>EventBroadcaster</strong>ï¼šäº‹ä»¶æ¶ˆè´¹è€…ã€‚æ¶ˆè´¹ EventRecorder è®°å½•çš„äº‹ä»¶å¹¶åˆ†å‘ç»™æ‰€æœ‰å·²è¿æ¥çš„ broadcasterWatcherã€‚æœ‰éé˜»å¡åˆ†å‘å’Œé˜»å¡åˆ†å‘æœºåˆ¶ã€‚</li><li><strong>broadcasterWatcher</strong>ï¼šç”¨äºå®šä¹‰äº‹ä»¶çš„å¤„ç†æ–¹å¼ï¼Œå¦‚ä¸ŠæŠ¥åˆ° API Serverã€‚</li></ul><p><strong>1. EventRecorder</strong></p><p>EventRecorder æ¥å£æ–¹æ³•ä»¥åŠä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>EventRecorder</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>Event</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>  <span class=c1>// è®°å½•åˆšå‘ç”Ÿçš„äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>Eventf</span><span class=p>(</span><span class=o>...</span><span class=p>)</span> <span class=c1>// æ ¼å¼åŒ–è¾“å‡ºäº‹ä»¶çš„æ ¼å¼
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>PastEventf</span><span class=p>(</span><span class=o>...</span><span class=p>)</span> <span class=c1>// å…è®¸è‡ªå®šä¹‰äº‹ä»¶å‘ç”Ÿçš„äº‹ä»¶ï¼Œä»¥è®°å½•å·²å‘ç”Ÿè¿‡çš„æ¶ˆæ¯
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>AnnotatedEventf</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>    <span class=c1>// åŠŸèƒ½ä¸ Eventf ä¸€æ ·ï¼Œæ·»åŠ äº† Annotation å­—æ®µ
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Event æœ€ç»ˆä¼šè°ƒç”¨åˆ° Action å‡½æ•°å¼‚æ­¥åœ°å°†äº‹ä»¶å†™å…¥ m.incoming Chanã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>Broadcaster</span><span class=p>)</span> <span class=nf>Action</span><span class=p>(</span><span class=nx>action</span> <span class=nx>EventType</span><span class=p>,</span> <span class=nx>obj</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>m</span><span class=p>.</span><span class=nx>incoming</span> <span class=o>&lt;-</span> <span class=nx>Event</span><span class=p>{</span><span class=nx>action</span><span class=p>,</span> <span class=nx>obj</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>2. EventBroadcaster</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// EventBroadcaster å®ä¾‹åŒ–ç¤ºä¾‹
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>NewBroadcaster</span><span class=p>()</span> <span class=nx>EventBroadcaster</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>eventBroadcasterImpl</span><span class=p>{</span><span class=nx>watch</span><span class=p>.</span><span class=nf>NewBroadcaster</span><span class=p>(</span><span class=nx>maxQueuedEvents</span><span class=p>,</span> <span class=nx>watch</span><span class=p>.</span><span class=nx>DropIfChannelFull</span><span class=p>),</span> <span class=nx>defaultSleepDuration</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>watch.NewBroadcaster</code> ä¼šåœ¨å‡½æ•°å†…éƒ¨å¯åŠ¨ goroutine ç›‘æ§ m.incomingï¼Œå¹¶å°†ç›‘æ§çš„äº‹ä»¶é€šè¿‡ <code>m.distribute</code> å‡½æ•°åˆ†å‘ç»™æ‰€æœ‰å·²è¿æ¥çš„ broadcasterWatcherã€‚</p><p>åˆ†å‘æœ‰ä¸¤ç§æœºåˆ¶ï¼š<strong>éé˜»å¡åˆ†å‘æœºåˆ¶</strong> å’Œ <strong>é˜»å¡åˆ†å‘æœºåˆ¶</strong>ã€‚å…¶ä¸­ï¼Œéé˜»å¡åˆ†å‘ç”¨ <code>DropIfChannelFull</code> æ ‡è¯†ï¼Œé˜»å¡åˆ†å‘ç”¨ <code>WaitIfChannelFull</code> æ ‡è¯†ï¼Œé»˜è®¤ä¸ºéé˜»å¡ï¼Œç¤ºä¾‹ä»£ç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>Broadcaster</span><span class=p>)</span> <span class=nf>distribute</span><span class=p>(</span><span class=nx>event</span> <span class=nx>Event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>m</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>m</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>m</span><span class=p>.</span><span class=nx>fullChannelBehavior</span> <span class=o>==</span> <span class=nx>DropIfChannelFull</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>w</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>m</span><span class=p>.</span><span class=nx>watchers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>w</span><span class=p>.</span><span class=nx>result</span> <span class=o>&lt;-</span> <span class=nx>event</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>w</span><span class=p>.</span><span class=nx>stopped</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>w</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>m</span><span class=p>.</span><span class=nx>watchers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>w</span><span class=p>.</span><span class=nx>result</span> <span class=o>&lt;-</span> <span class=nx>event</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>w</span><span class=p>.</span><span class=nx>stopped</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>éé˜»å¡ä½¿ç”¨ select ä¸­çš„ default å…³é”®å­—å®ç°ï¼Œå½“ç¼“å†²åŒºæ»¡æ—¶ï¼Œäº‹ä»¶ä¸¢å¤±ã€‚è€Œé˜»å¡æ–¹å¼åœ¨ç¼“å†²åŒºæ»¡æ—¶ä¼šé€‰æ‹©ç­‰å¾…ã€‚</p><blockquote><p>Kubernetes ä¸­çš„äº‹ä»¶èµ„æºä¸å…¶ä»–èµ„æºä¸åŒçš„æ˜¯å®ƒå¯ä»¥ä¸¢å¤±ã€‚</p></blockquote><p><strong>3. broadcasterWatcher</strong></p><p>broadcasterWatcher æ˜¯æ¯ä¸ªç³»ç»Ÿç»„ä»¶è‡ªå®šä¹‰å¤„ç†äº‹ä»¶çš„æ–¹å¼ã€‚æ¯ä¸ª broadcasterWatcher æœ‰ä¸¤ç§è‡ªå®šä¹‰å¤„ç†äº‹ä»¶çš„å‡½æ•°ï¼š</p><ul><li><strong>StartLogging</strong>ï¼šå°†äº‹ä»¶å†™å…¥æ—¥å¿—ã€‚</li><li><strong>StartRecordingToSink</strong>ï¼šå°†äº‹ä»¶ä¸ŠæŠ¥åˆ° API Server å¹¶å­˜åˆ° Etcdã€‚</li></ul><p>ä¸Šé¢è¿™ä¸¤ä¸ªå‡½æ•°éƒ½ä¾èµ–äº <code>StartEventWatcher</code> å‡½æ•°ï¼Œå…¶å†…éƒ¨è·‘äº†ä¸€ä¸ª goroutineï¼Œä¸æ–­ç›‘æ§ EventBroadcaster æ¥å‘ç°äº‹ä»¶å¹¶è°ƒç”¨ç›¸å…³å‡½æ•°å¯¹äº‹ä»¶å¤„ç†ã€‚</p><p>ä»¥ kube-scheduler ç»„ä»¶ä¸ºä¾‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>if</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>Broadcaster</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>EventClient</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>cc</span><span class=p>.</span><span class=nx>Broadcaster</span><span class=p>.</span><span class=nf>StartLogging</span><span class=p>(</span><span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>6</span><span class=p>).</span><span class=nf>Info</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=nx>cc</span><span class=p>.</span><span class=nx>Broadcaster</span><span class=p>.</span><span class=nf>StartRecordingToSink</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>v1core</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=nx>EventSinkImpl</span><span class=p>{</span><span class=nx>Interface</span><span class=p>:</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>EventClient</span><span class=p>.</span><span class=nf>Events</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>)})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å®ƒå°† <code>v1core.EventSinkImpl</code> ä½œä¸ºä¸ŠæŠ¥äº‹ä»¶çš„è‡ªå®šä¹‰å‡½æ•°ã€‚ä¸ŠæŠ¥äº‹ä»¶æœ‰ 3 ç§æ–¹æ³•ï¼šCreateï¼ˆPost æ–¹æ³•ï¼‰ã€Updateï¼ˆPut æ–¹æ³•ï¼‰ã€Patchï¼ˆPatch æ–¹æ³•ï¼‰ã€‚ä»¥ Create ä¸ºä¾‹ï¼Œ<code>Create</code> => <code>e.Interface.CreateWithEventNamespace</code>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>e</span> <span class=o>*</span><span class=nx>events</span><span class=p>)</span> <span class=nf>CreateWithEventNamespace</span><span class=p>(</span><span class=nx>event</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Event</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Event</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>result</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Event</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>e</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>Post</span><span class=p>().</span>
</span></span><span class=line><span class=cl>        <span class=nf>NamespaceIfScoped</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span><span class=p>).</span>
</span></span><span class=line><span class=cl>        <span class=nf>Resource</span><span class=p>(</span><span class=s>&#34;events&#34;</span><span class=p>).</span>
</span></span><span class=line><span class=cl>        <span class=nf>Body</span><span class=p>(</span><span class=nx>event</span><span class=p>).</span>
</span></span><span class=line><span class=cl>        <span class=nf>Do</span><span class=p>().</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸ŠæŠ¥è¿‡ç¨‹é€šè¿‡ RESTClient å‘é€ Post è¯·æ±‚ï¼Œå°†äº‹ä»¶å‘é€åˆ° API Serverï¼Œæœ€ç»ˆå­˜åœ¨ Etcdã€‚</p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 Example Person</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.21.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>